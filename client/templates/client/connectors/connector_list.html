{% extends "base.html" %}
{% load static %}

{% block content %}
<div x-data="{ deleteModal: { open: false, pk: null, name: '', tables: 0, confirmed: false } }">

<!-- Page Header -->
<div class="flex justify-between items-center mb-6">
    <div>
        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">CDC Connectors - {{ database.connection_name }}</h2>
        <p class="text-gray-600 dark:text-gray-400 mt-1">
            Client: <span class="font-semibold">{{ client.name }}</span> |
            Database: <span class="font-semibold">{{ database.db_type|upper }}</span> @ {{ database.host }}:{{ database.port }}
        </p>
    </div>
    <div class="flex gap-2">
        <a href="{% url 'client_detail' client.pk %}?tab=databases"
           class="inline-flex items-center px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition">
            <- Back to Client
        </a>
        {% if can_add_connector %}
        <a href="{% url 'connector_add' database.pk %}"
           class="inline-flex items-center px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition">
            + Add Source Connector
        </a>
        {% endif %}
    </div>
</div>

<!-- Summary Cards -->
<div class="flex gap-4 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow px-5 py-3 flex items-center gap-3">
        <span class="text-2xl font-bold text-gray-900 dark:text-white">{{ health_summary.total_source_connectors }}</span>
        <span class="text-sm text-gray-600 dark:text-gray-400">Source Connectors</span>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow px-5 py-3 flex items-center gap-3">
        <span class="text-2xl font-bold text-green-600 dark:text-green-400">{{ health_summary.running_source_connectors }}</span>
        <span class="text-sm text-gray-600 dark:text-gray-400">Running</span>
    </div>
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow px-5 py-3 flex items-center gap-3">
        <span class="text-2xl font-bold text-gray-900 dark:text-white">{{ health_summary.total_tables }}</span>
        <span class="text-sm text-gray-600 dark:text-gray-400">Tables Replicated</span>
    </div>
</div>

<!-- Source Connectors -->
{% if source_connectors %}
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
        <!-- Table Header -->
        <div class="bg-gray-100 dark:bg-gray-700 px-4 py-3 border-b border-gray-200 dark:border-gray-600">
            <div class="grid grid-cols-12 gap-4 items-center text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                <div class="col-span-4">Connector Name</div>
                <div class="col-span-1 text-center">Mode</div>
                <div class="col-span-1 text-center">Tables</div>
                <div class="col-span-2 text-center">Created</div>
                <div class="col-span-4 text-right">Actions</div>
            </div>
        </div>

        <!-- Connector Rows -->
        {% for config in source_connectors %}
        <div class="border-b border-gray-200 dark:border-gray-700 last:border-b-0" x-data="{ expanded: false }">
            <!-- Main Row -->
            <div class="px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700/50 transition">
                <div class="grid grid-cols-12 gap-4 items-center">
                    <!-- Connector Name & Status -->
                    <div class="col-span-4">
                        <div class="flex items-center gap-3">
                            <div>
                                <div class="flex items-center gap-2">
                                    <span class="font-semibold text-gray-900 dark:text-white">{{ config.connector_name }}</span>
                                    {% if config.debezium_status.state == 'RUNNING' %}
                                        <span class="px-2 py-0.5 rounded text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">RUNNING</span>
                                    {% elif config.debezium_status.state == 'FAILED' %}
                                        <span class="px-2 py-0.5 rounded text-xs font-medium bg-red-100 dark:bg-red-900/30 text-red-700 dark:text-red-400">FAILED</span>
                                    {% elif config.debezium_status.state == 'PAUSED' %}
                                        <span class="px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 dark:bg-yellow-900/30 text-yellow-700 dark:text-yellow-400">PAUSED</span>
                                    {% else %}
                                        <span class="px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-900/30 text-gray-700 dark:text-gray-400">{{ config.debezium_status.state|default:"UNKNOWN" }}</span>
                                    {% endif %}
                                </div>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-0.5">v{{ config.connector_version }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Mode -->
                    <div class="col-span-1 text-center">
                        {% if config.processing_mode == 'batch' %}
                            <span class="px-2 py-1 rounded text-xs font-medium bg-purple-100 dark:bg-purple-900/30 text-purple-700 dark:text-purple-400">Batch</span>
                        {% else %}
                            <span class="px-2 py-1 rounded text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-700 dark:text-green-400">CDC</span>
                        {% endif %}
                    </div>

                    <!-- Tables Count -->
                    <div class="col-span-1 text-center">
                        <span class="font-semibold text-gray-900 dark:text-white">{{ config.table_count }}</span>
                    </div>

                    <!-- Created Date -->
                    <div class="col-span-2 text-center text-sm text-gray-600 dark:text-gray-400">
                        {{ config.created_at|date:"M d, Y" }}
                    </div>

                    <!-- Actions -->
                    <div class="col-span-4 flex justify-end items-center gap-2">
                        <button @click="expanded = !expanded"
                                class="inline-flex items-center gap-1 px-3 py-1.5 text-sm font-medium text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-lg transition">
                            <svg class="w-4 h-4 transition-transform" :class="expanded ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                            </svg>
                            <span x-text="expanded ? 'Hide Tables' : 'Show Tables'">Show Tables</span>
                        </button>
                        <a href="{% url 'connector_monitor' config.pk %}"
                           class="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition">
                            Monitor
                        </a>
                        <a href="{% url 'connector_edit_tables' config.pk %}"
                           class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition">
                            Edit
                        </a>
                        <button @click="deleteModal = { open: true, pk: {{ config.pk }}, name: '{{ config.connector_name }}', tables: {{ config.table_count }}, confirmed: false }"
                                class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition">
                            Delete
                        </button>
                    </div>
                </div>
            </div>

            <!-- Expandable Tables Section -->
            <div x-show="expanded" x-collapse x-cloak class="bg-gray-50 dark:bg-gray-900/50 border-t border-gray-200 dark:border-gray-700">
                <div class="p-4">
                    <!-- Connector Settings Summary -->
                    {% if config.processing_mode == 'batch' %}
                    <div class="flex flex-wrap gap-4 mb-4 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 dark:text-gray-400">Sync Interval:</span>
                            <span class="font-medium text-gray-900 dark:text-white">{{ config.get_batch_interval_display|default:"-" }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 dark:text-gray-400">Max Duration:</span>
                            <span class="font-medium text-gray-900 dark:text-white">{{ config.batch_max_catchup_minutes }} min</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 dark:text-gray-400">Snapshot:</span>
                            <span class="font-medium text-gray-900 dark:text-white">{{ config.get_snapshot_mode_display }}</span>
                        </div>
                    </div>
                    {% else %}
                    <div class="flex flex-wrap gap-4 mb-4 text-sm">
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 dark:text-gray-400">Snapshot:</span>
                            <span class="font-medium text-gray-900 dark:text-white">{{ config.get_snapshot_mode_display }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 dark:text-gray-400">Max Queue:</span>
                            <span class="font-medium text-gray-900 dark:text-white">{{ config.max_queue_size }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 dark:text-gray-400">Max Batch:</span>
                            <span class="font-medium text-gray-900 dark:text-white">{{ config.max_batch_size }}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="text-gray-500 dark:text-gray-400">Poll Interval:</span>
                            <span class="font-medium text-gray-900 dark:text-white">{{ config.poll_interval_ms }}ms</span>
                        </div>
                    </div>
                    {% endif %}

                    <!-- Tables List -->
                    <div class="border border-gray-200 dark:border-gray-700 rounded-lg overflow-hidden bg-white dark:bg-gray-800">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-100 dark:bg-gray-700">
                                <tr>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase">Source Table</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase">Target Table</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase">Columns</th>
                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-600 dark:text-gray-300 uppercase">Status</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                {% for mapping in config.table_mappings.all %}
                                {% if mapping.is_enabled %}
                                <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                    <td class="px-4 py-2 text-sm font-medium text-gray-900 dark:text-white">{{ mapping.source_table }}</td>
                                    <td class="px-4 py-2 text-sm text-gray-900 dark:text-white">{{ mapping.target_table }}</td>
                                    <td class="px-4 py-2 text-sm text-gray-600 dark:text-gray-400">{{ mapping.get_column_count }}</td>
                                    <td class="px-4 py-2">
                                        <span class="px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 dark:bg-green-900/30 text-green-800 dark:text-green-400">Enabled</span>
                                    </td>
                                </tr>
                                {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
{% else %}
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-6 text-center">
        <h5 class="text-lg font-semibold text-blue-900 dark:text-blue-100 mb-2">No source connectors configured</h5>
        <p class="text-blue-700 dark:text-blue-300">Click "Add Source Connector" to create your first connector.</p>
    </div>
{% endif %}


<!-- Info Box -->
{% if not can_add_connector %}
<div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mt-4">
    <div class="flex">
        <div class="flex-shrink-0">
            <svg class="h-5 w-5 text-yellow-600 dark:text-yellow-400" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
            </svg>
        </div>
        <div class="ml-3">
            <h3 class="text-sm font-semibold text-yellow-800 dark:text-yellow-200">All tables are assigned</h3>
            <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-1">All tables from this database are already assigned to connectors. To add more tables, remove them from existing connectors first.</p>
        </div>
    </div>
</div>
{% endif %}

{% include "client/connectors/_delete_modal.html" %}
</div>

{% endblock %}