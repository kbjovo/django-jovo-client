{% extends "base.html" %}
{% load static %}

{% block title %}Configure CDC Tables - {{ client.name }}{% endblock %}

{% block extra_css %}
<style>
    .table-card {
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        margin-bottom: 20px;
        overflow: hidden;
    }
    .table-card-header {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .table-card-body {
        padding: 20px;
    }
    .sync-type-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }
    .sync-type-option {
        flex: 1;
        padding: 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: center;
    }
    .sync-type-option input[type="radio"] {
        display: none;
    }
    .sync-type-option:hover {
        border-color: #007bff;
        background: #f8f9ff;
    }
    .sync-type-option input[type="radio"]:checked + label {
        border-color: #007bff;
        background: #e7f1ff;
    }
    .sync-type-option label {
        cursor: pointer;
        margin: 0;
        font-weight: 500;
    }
    .sync-type-description {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 5px;
    }
    .incremental-config {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        margin-top: 15px;
        display: none;
    }
    .incremental-config.active {
        display: block;
    }
    .column-badge {
        display: inline-block;
        padding: 4px 8px;
        background: #e9ecef;
        border-radius: 4px;
        font-size: 0.875rem;
        margin-right: 5px;
        margin-bottom: 5px;
    }
    .column-badge.primary-key {
        background: #ffc107;
        color: #000;
    }
    .table-info {
        display: flex;
        gap: 20px;
        font-size: 0.875rem;
        color: #6c757d;
    }
    .progress-steps {
        display: flex;
        justify-content: center;
        margin-bottom: 30px;
    }
    .step {
        display: flex;
        align-items: center;
        position: relative;
    }
    .step-number {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e9ecef;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 10px;
    }
    .step.completed .step-number {
        background: #28a745;
        color: white;
    }
    .step.active .step-number {
        background: #007bff;
        color: white;
    }
    .step-connector {
        width: 100px;
        height: 2px;
        background: #e9ecef;
        margin: 0 10px;
    }
    .step.completed .step-connector {
        background: #28a745;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'client_detail' client.pk %}">{{ client.name }}</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'cdc_dashboard' client.pk %}">CDC Dashboard</a></li>
                    <li class="breadcrumb-item active">Configure Tables</li>
                </ol>
            </nav>

            <!-- Progress Steps -->
            <div class="progress-steps mb-4">
                <div class="step completed">
                    <div class="step-number">1</div>
                    <span>Discover Tables</span>
                </div>
                <div class="step-connector"></div>
                <div class="step active">
                    <div class="step-number">2</div>
                    <span>Configure Tables</span>
                </div>
                <div class="step-connector"></div>
                <div class="step">
                    <div class="step-number">3</div>
                    <span>Create Connector</span>
                </div>
            </div>

            <!-- Page Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2>Configure CDC Tables</h2>
                    <p class="text-muted mb-0">
                        Configure sync type and incremental columns for {{ tables|length }} selected table{{ tables|length|pluralize }}
                    </p>
                </div>
            </div>

            <!-- Configuration Form -->
            <form method="POST" id="configureTablesForm">
                {% csrf_token %}

                <!-- Global Sync Type (Optional) -->
                <div class="card mb-4">
                    <div class="card-body">
                        <h5 class="card-title">Default Sync Type</h5>
                        <p class="text-muted">Select a default sync type for all tables (can be overridden per table)</p>
                        <select class="form-control" id="globalSyncType" style="max-width: 300px;">
                            <option value="">-- Set individually --</option>
                            <option value="realtime">Real-time CDC</option>
                            <option value="incremental">Incremental</option>
                            <option value="full">Full Refresh</option>
                        </select>
                    </div>
                </div>

                <!-- Table Configuration Cards -->
                {% for table in tables %}
                <div class="table-card">
                    <div class="table-card-header">
                        <div>
                            <h5 class="mb-1">{{ table.name }}</h5>
                            <div class="table-info">
                                <span>üìä {{ table.columns|length }} columns</span>
                                {% if table.primary_keys %}
                                <span>üîë Primary Key: {{ table.primary_keys|join:", " }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-card-body">
                        <!-- Sync Type Selection -->
                        <div class="sync-type-selector">
                            <div class="sync-type-option">
                                <input type="radio" 
                                       id="realtime_{{ table.name }}" 
                                       name="sync_type_{{ table.name }}" 
                                       value="realtime"
                                       checked>
                                <label for="realtime_{{ table.name }}">
                                    <div>üîÑ Real-time CDC</div>
                                    <div class="sync-type-description">Capture changes as they happen</div>
                                </label>
                            </div>
                            
                            <div class="sync-type-option">
                                <input type="radio" 
                                       id="incremental_{{ table.name }}" 
                                       name="sync_type_{{ table.name }}" 
                                       value="incremental">
                                <label for="incremental_{{ table.name }}">
                                    <div>üìà Incremental</div>
                                    <div class="sync-type-description">Sync new/updated records only</div>
                                </label>
                            </div>
                            
                            <div class="sync-type-option">
                                <input type="radio" 
                                       id="full_{{ table.name }}" 
                                       name="sync_type_{{ table.name }}" 
                                       value="full">
                                <label for="full_{{ table.name }}">
                                    <div>üîÉ Full Refresh</div>
                                    <div class="sync-type-description">Replace all data on each sync</div>
                                </label>
                            </div>
                        </div>

                        <!-- Incremental Column Configuration -->
                        <div class="incremental-config" id="incremental_config_{{ table.name }}">
                            <label class="font-weight-bold">Select Incremental Column:</label>
                            <select class="form-control mt-2" name="incremental_col_{{ table.name }}">
                                <option value="">-- Select a column --</option>
                                {% for col in table.incremental_candidates %}
                                <option value="{{ col.name }}">
                                    {{ col.name }} ({{ col.type }})
                                    {% if col.name in table.primary_keys %}üîë{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            <small class="form-text text-muted mt-1">
                                Choose a timestamp or auto-incrementing column to track changes
                            </small>
                        </div>

                        <!-- Column Preview -->
                        <div class="mt-3">
                            <button type="button" 
                                    class="btn btn-sm btn-outline-secondary" 
                                    data-toggle="collapse" 
                                    data-target="#columns_{{ table.name }}">
                                üëÅÔ∏è View Columns ({{ table.columns|length }})
                            </button>
                            <div class="collapse mt-2" id="columns_{{ table.name }}">
                                <div class="p-3" style="background: #f8f9fa; border-radius: 6px;">
                                    {% for col in table.columns %}
                                    <span class="column-badge {% if col.name in table.primary_keys %}primary-key{% endif %}">
                                        {{ col.name }}
                                        <small class="text-muted">({{ col.type }})</small>
                                    </span>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}

                <!-- Action Buttons -->
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <a href="{% url 'cdc_discover_tables' db_config.pk %}" class="btn btn-outline-secondary">
                                ‚Üê Back to Table Selection
                            </a>
                            <button type="submit" class="btn btn-primary btn-lg">
                                Continue to Connector Setup ‚Üí
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle sync type changes
    document.querySelectorAll('input[type="radio"][name^="sync_type_"]').forEach(function(radio) {
        radio.addEventListener('change', function() {
            const tableName = this.name.replace('sync_type_', '');
            const incrementalConfig = document.getElementById('incremental_config_' + tableName);
            
            if (this.value === 'incremental') {
                incrementalConfig.classList.add('active');
            } else {
                incrementalConfig.classList.remove('active');
            }
        });
        
        // Visual feedback for selected option
        radio.closest('.sync-type-option').addEventListener('click', function() {
            const radioInput = this.querySelector('input[type="radio"]');
            radioInput.checked = true;
            radioInput.dispatchEvent(new Event('change'));
            
            // Update visual state
            this.closest('.sync-type-selector').querySelectorAll('.sync-type-option').forEach(function(opt) {
                opt.style.borderColor = '#e0e0e0';
                opt.style.background = '#fff';
            });
            this.style.borderColor = '#007bff';
            this.style.background = '#e7f1ff';
        });
    });

    // Global sync type handler
    document.getElementById('globalSyncType').addEventListener('change', function() {
        const globalType = this.value;
        if (globalType) {
            document.querySelectorAll('input[type="radio"][value="' + globalType + '"]').forEach(function(radio) {
                radio.checked = true;
                radio.dispatchEvent(new Event('change'));
                radio.closest('.sync-type-option').click();
            });
        }
    });

    // Form validation
    document.getElementById('configureTablesForm').addEventListener('submit', function(e) {
        let hasError = false;
        
        // Check if incremental tables have a column selected
        document.querySelectorAll('input[type="radio"][value="incremental"]:checked').forEach(function(radio) {
            const tableName = radio.name.replace('sync_type_', '');
            const select = document.querySelector('select[name="incremental_col_' + tableName + '"]');
            
            if (!select.value) {
                hasError = true;
                alert('Please select an incremental column for table: ' + tableName);
                select.focus();
            }
        });
        
        if (hasError) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}