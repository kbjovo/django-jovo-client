{% extends "base.html" %}
{% load static %}

{% block title %}Edit Configuration - {{ replication_config.client_database.connection_name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <!-- Breadcrumb -->
  <nav class="flex mb-6" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
      <li class="inline-flex items-center">
        <a href="{% url 'main-dashboard' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
          <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
          </svg>
          Dashboard
        </a>
      </li>
      <li>
        <div class="flex items-center">
          <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
          <a href="{% url 'client_detail' client.pk %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">{{ client.name }}</a>
        </div>
      </li>
      <li aria-current="page">
        <div class="flex items-center">
          <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
          <span class="ml-1 text-sm font-medium text-gray-500 dark:text-gray-400">Edit Configuration</span>
        </div>
      </li>
    </ol>
  </nav>

  <!-- Header -->
  <div class="flex items-center justify-between mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Edit CDC Configuration</h1>
      <p class="text-gray-600 dark:text-gray-400 mt-1">
        Configure replication settings for <span class="font-semibold">{{ db_config.connection_name }}</span>
      </p>
    </div>
    <div class="flex items-center gap-3">
      {% if replication_config.connector_name %}
      <a href="{% url 'cdc_monitor_connector' replication_config.pk %}"
         class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to Monitor
      </a>
      {% else %}
      <a href="{% url 'main-dashboard' %}"
         class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700">
        <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
        </svg>
        Back to Dashboard
      </a>
      {% endif %}
    </div>
  </div>

  <form method="post" action="" x-data="configForm()">
    {% csrf_token %}

    <!-- Basic Configuration Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Basic Configuration</h2>
      </div>
      <div class="p-6 space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Sync Type -->
          <div>
            <label for="sync_type" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sync Type</label>
            <select
              id="sync_type"
              name="sync_type"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"
            >
              <option value="full" {% if replication_config.sync_type == 'full' %}selected{% endif %}>Full Refresh</option>
              <option value="incremental" {% if replication_config.sync_type == 'incremental' %}selected{% endif %}>Incremental Sync</option>
              <option value="realtime" {% if replication_config.sync_type == 'realtime' %}selected{% endif %}>Real-time CDC</option>
            </select>
          </div>

          <!-- Sync Frequency -->
          <div>
            <label for="sync_frequency" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sync Frequency</label>
            <select
              id="sync_frequency"
              name="sync_frequency"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500"
            >
              <option value="realtime" {% if replication_config.sync_frequency == 'realtime' %}selected{% endif %}>Real-time (CDC)</option>
              <option value="every_1min" {% if replication_config.sync_frequency == 'every_1min' %}selected{% endif %}>Every 1 minute</option>
              <option value="every_5min" {% if replication_config.sync_frequency == 'every_5min' %}selected{% endif %}>Every 5 minutes</option>
              <option value="every_15min" {% if replication_config.sync_frequency == 'every_15min' %}selected{% endif %}>Every 15 minutes</option>
              <option value="every_30min" {% if replication_config.sync_frequency == 'every_30min' %}selected{% endif %}>Every 30 minutes</option>
              <option value="hourly" {% if replication_config.sync_frequency == 'hourly' %}selected{% endif %}>Hourly</option>
              <option value="daily" {% if replication_config.sync_frequency == 'daily' %}selected{% endif %}>Daily</option>
              <option value="manual" {% if replication_config.sync_frequency == 'manual' %}selected{% endif %}>Manual Only</option>
            </select>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <!-- Auto Create Tables -->
          <div class="flex items-center">
            <input
              type="checkbox"
              id="auto_create_tables"
              name="auto_create_tables"
              {% if replication_config.auto_create_tables %}checked{% endif %}
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            >
            <label for="auto_create_tables" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
              Auto-create tables if they don't exist
            </label>
          </div>

          <!-- Drop Before Sync -->
          <div class="flex items-center">
            <input
              type="checkbox"
              id="drop_before_sync"
              name="drop_before_sync"
              {% if replication_config.drop_before_sync %}checked{% endif %}
              class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
            >
            <label for="drop_before_sync" class="ml-2 text-sm text-gray-700 dark:text-gray-300">
              Drop and recreate tables before sync
            </label>
          </div>
        </div>
      </div>
    </div>

    <!-- Tables Configuration Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow mb-6">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h2 class="text-lg font-semibold text-gray-900 dark:text-white">Table Selection & Configuration</h2>
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">Select tables to replicate and configure individual table settings</p>
      </div>
      <div class="divide-y divide-gray-200 dark:divide-gray-700">
        {% for table in tables_with_columns %}
        <div class="p-6">
          <!-- Table Header -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <input
                type="checkbox"
                id="table_checkbox_{{ table.table_name }}"
                name="selected_tables"
                value="{{ table.table_name }}"
                {% if table.is_mapped %}checked{% endif %}
                class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                @change="toggleTableSelection('table_{{ table.table_name }}', $event.target.checked)"
              >
              <label for="table_checkbox_{{ table.table_name }}" class="text-lg font-semibold text-gray-900 dark:text-white cursor-pointer">
                {{ table.table_name }}
              </label>
              {% if table.is_mapped %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400">
                Currently Mapped
              </span>
              {% else %}
              <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-600 dark:bg-gray-700 dark:text-gray-400">
                Available
              </span>
              {% endif %}
              <span class="text-xs text-gray-500 dark:text-gray-400">
                {{ table.row_count }} rows, {{ table.column_count }} columns
              </span>
            </div>
            <button
              type="button"
              @click="expandedTables['table_{{ table.table_name }}'] = !expandedTables['table_{{ table.table_name }}'] || false"
              class="text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300"
            >
              <span x-show="!expandedTables['table_{{ table.table_name }}']">Configure</span>
              <span x-show="expandedTables['table_{{ table.table_name }}']">Hide</span>
            </button>
          </div>

          <!-- Table Details (Collapsible) - For all tables -->
          <div x-show="expandedTables['table_{{ table.table_name }}']" x-collapse class="space-y-4 mt-4">
            <!-- Table Settings -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
              <!-- Target Table Name -->
              <div>
                <label for="target_table_new_{{ table.table_name }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Target Table Name</label>
                <input
                  type="text"
                  id="target_table_new_{{ table.table_name }}"
                  name="target_table_new_{{ table.table_name }}"
                  value="{% if table.is_mapped %}{{ table.mapping.target_table }}{% else %}{{ table.default_target_name }}{% endif %}"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500"
                >
              </div>

              <!-- Sync Type Override -->
              <div>
                <label for="sync_type_table_new_{{ table.table_name }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Sync Type</label>
                <select
                  id="sync_type_table_new_{{ table.table_name }}"
                  name="sync_type_table_new_{{ table.table_name }}"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500"
                >
                  <option value="" selected>Inherit from Config</option>
                  <option value="full" {% if table.is_mapped and table.mapping.sync_type == 'full' %}selected{% endif %}>Full Refresh</option>
                  <option value="incremental" {% if table.is_mapped and table.mapping.sync_type == 'incremental' %}selected{% endif %}>Incremental</option>
                  <option value="realtime" {% if table.is_mapped and table.mapping.sync_type == 'realtime' %}selected{% endif %}>Real-time CDC</option>
                </select>
              </div>

              <!-- Incremental Column -->
              <div>
                <label for="incremental_col_table_new_{{ table.table_name }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Incremental Column</label>
                <select
                  id="incremental_col_table_new_{{ table.table_name }}"
                  name="incremental_col_table_new_{{ table.table_name }}"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">None</option>
                  {% for col in table.incremental_candidates %}
                  <option value="{{ col.name }}" {% if table.is_mapped and table.mapping.incremental_column == col.name %}selected{% endif %}>{{ col.name }}</option>
                  {% endfor %}
                </select>
              </div>
            </div>

            <!-- Conflict Resolution -->
            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
              <label for="conflict_resolution_table_new_{{ table.table_name }}" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Conflict Resolution</label>
              <select
                id="conflict_resolution_table_new_{{ table.table_name }}"
                name="conflict_resolution_table_new_{{ table.table_name }}"
                class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500"
              >
                <option value="source_wins" {% if not table.is_mapped or table.mapping.conflict_resolution == 'source_wins' %}selected{% endif %}>Source Always Wins</option>
                <option value="target_wins" {% if table.is_mapped and table.mapping.conflict_resolution == 'target_wins' %}selected{% endif %}>Target Always Wins</option>
                <option value="newest_wins" {% if table.is_mapped and table.mapping.conflict_resolution == 'newest_wins' %}selected{% endif %}>Newest Timestamp Wins</option>
                <option value="manual" {% if table.is_mapped and table.mapping.conflict_resolution == 'manual' %}selected{% endif %}>Manual Resolution</option>
              </select>
            </div>

            <!-- Columns List -->
            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
              <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Column Mappings</h4>
              <div class="space-y-2 max-h-64 overflow-y-auto">
                {% if table.is_mapped %}
                  {% for column in table.columns %}
                  <div class="flex items-center gap-3 p-2 bg-white dark:bg-gray-800 rounded">
                    <input
                      type="checkbox"
                      id="enabled_column_{{ column.id }}"
                      name="enabled_column_{{ column.id }}"
                      {% if column.is_enabled %}checked{% endif %}
                      class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    >
                    <div class="flex-1 grid grid-cols-2 gap-2">
                      <div>
                        <label for="enabled_column_{{ column.id }}" class="text-sm font-mono text-gray-900 dark:text-white cursor-pointer">
                          {{ column.source_column }}
                        </label>
                        <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">{{ column.source_type }}</span>
                      </div>
                      <input
                        type="text"
                        id="target_column_{{ column.id }}"
                        name="target_column_{{ column.id }}"
                        value="{{ column.target_column }}"
                        placeholder="Target column name"
                        class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-1 focus:ring-blue-500"
                      >
                    </div>
                  </div>
                  {% endfor %}
                {% else %}
                  {% for column in table.all_columns %}
                  <div class="flex items-center gap-3 p-2 bg-white dark:bg-gray-800 rounded">
                    <input
                      type="checkbox"
                      id="enabled_column_new_{{ table.table_name }}_{{ column.name }}"
                      name="enabled_column_new_{{ table.table_name }}_{{ column.name }}"
                      checked
                      class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
                    >
                    <div class="flex-1 grid grid-cols-2 gap-2">
                      <div>
                        <label for="enabled_column_new_{{ table.table_name }}_{{ column.name }}" class="text-sm font-mono text-gray-900 dark:text-white cursor-pointer">
                          {{ column.name }}
                        </label>
                        <span class="text-xs text-gray-500 dark:text-gray-400 ml-2">{{ column.type }}</span>
                      </div>
                      <input
                        type="text"
                        id="target_column_new_{{ table.table_name }}_{{ column.name }}"
                        name="target_column_new_{{ table.table_name }}_{{ column.name }}"
                        value="{{ column.name }}"
                        placeholder="Target column name"
                        class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-1 focus:ring-blue-500"
                      >
                    </div>
                  </div>
                  {% endfor %}
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Save Options Section -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <!-- Hidden inputs for mandatory restart when connector exists -->
      {% if replication_config.connector_name %}
      <input type="hidden" name="restart_connector" value="true">
      <input type="hidden" name="restart_consumer" value="true">
      {% endif %}

      <div class="flex items-center justify-end gap-3">
        {% if replication_config.connector_name %}
        <a
          href="{% url 'cdc_monitor_connector' replication_config.pk %}"
          class="inline-flex items-center px-6 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
        >
          Cancel
        </a>
        {% else %}
        <a
          href="{% url 'main-dashboard' %}"
          class="inline-flex items-center px-6 py-3 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
        >
          Cancel
        </a>
        {% endif %}
        <button
          type="submit"
          class="inline-flex items-center px-6 py-3 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          Save Changes{% if replication_config.connector_name %} & Restart{% endif %}
        </button>
      </div>
    </div>

  </form>

</div>

<script>
// Initialize Alpine.js data for the configuration form
function configForm() {
  return {
    expandedTables: {},

    // Toggle table selection and auto-expand configuration
    toggleTableSelection(tableId, isChecked) {
      if (isChecked) {
        // Auto-expand configuration when table is selected
        this.expandedTables[tableId] = true;
      } else {
        // Optionally collapse when unselected (you can remove this if you want to keep it expanded)
        this.expandedTables[tableId] = false;
      }
    }
  }
}
</script>

{% endblock %}