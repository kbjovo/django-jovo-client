server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # ============================================
  # ALL Docker Container Logs - Unified Capture
  # ============================================
  - job_name: docker-containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.project=jovoclient"]
    
    relabel_configs:
      # Extract container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container_name'
      
      # Extract container ID
      - source_labels: ['__meta_docker_container_id']
        target_label: 'container_id'
      
      # Map container names to service names
      - source_labels: ['container_name']
        regex: '(django).*'
        target_label: 'service'
        replacement: 'django'
      
      - source_labels: ['container_name']
        regex: '(celery-worker).*'
        target_label: 'service'
        replacement: 'celery-worker'
      
      - source_labels: ['container_name']
        regex: '(celery-consumer).*'
        target_label: 'service'
        replacement: 'celery-consumer'
      
      - source_labels: ['container_name']
        regex: '(celery-beat).*'
        target_label: 'service'
        replacement: 'celery-beat'
      
      - source_labels: ['container_name']
        regex: '(kafka-connect).*'
        target_label: 'service'
        replacement: 'kafka-connect'
      
      - source_labels: ['container_name']
        regex: '(kafka-[123]).*'
        target_label: 'service'
        replacement: 'kafka'
      
      - source_labels: ['container_name']
        regex: '(schema-registry).*'
        target_label: 'service'
        replacement: 'schema-registry'
      
      - source_labels: ['container_name']
        regex: '(mysql.*).*'
        target_label: 'service'
        replacement: 'mysql'
      
      - source_labels: ['container_name']
        regex: '(redis).*'
        target_label: 'service'
        replacement: 'redis'

    pipeline_stages:
      # Parse Docker JSON logs
      - json:
          expressions:
            output: log
            stream: stream
            timestamp: time
      
      # Parse timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      # Try to extract log level from various formats
      - regex:
          source: output
          expression: '.*\[(?P<level>DEBUG|INFO|WARN|WARNING|ERROR|CRITICAL|FATAL)\].*'
      
      # If level not found, try another pattern
      - regex:
          source: output
          expression: '.*(?P<level>DEBUG|INFO|WARN|WARNING|ERROR|CRITICAL|FATAL)\s.*'
      
      # Add level as label if found
      - labels:
          level:
          stream:
      
      # Output the log message
      - output:
          source: output

  # ============================================
  # Django Application Logs - JSON Format
  # ============================================
  - job_name: django-json-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: django-json
          service: django
          log_type: application
          __path__: /app/logs/application.json

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            module: module
            function: function
            line: line
            client_id: client_id
            connector_name: connector_name
            table_name: table_name
            operation: operation
            duration: duration_seconds
            error_type: error_type
            error_message: error_message
            status: status

      - labels:
          level:
          logger:
          module:
          operation:
          status:

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - output:
          source: message

  # ============================================
  # CDC-Specific Logs - JSON Format
  # ============================================
  - job_name: cdc-json-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: cdc-json
          service: cdc
          log_type: cdc
          __path__: /app/logs/cdc.json

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            module: module
            client_id: client_id
            connector_name: connector_name
            table_name: table_name
            operation: operation
            duration: duration_seconds
            status: status
            error_type: error_type

      - labels:
          level:
          logger:
          operation:
          status:

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - output:
          source: message

  # ============================================
  # Celery Logs - JSON Format
  # ============================================
  - job_name: celery-json-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: celery-json
          service: celery
          log_type: celery
          __path__: /app/logs/celery.json

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            task_name: task_name
            task_id: task_id
            queue: queue
            operation: operation
            duration: duration_seconds
            status: status
            error_type: error_type

      - labels:
          level:
          logger:
          queue:
          operation:
          status:

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - output:
          source: message

  # ============================================
  # Error Logs - JSON Format
  # ============================================
  - job_name: error-json-logs
    static_configs:
      - targets:
          - localhost
        labels:
          job: error-json
          service: errors
          log_type: error
          severity: error
          __path__: /app/logs/errors.json

    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            module: module
            error_type: error_type
            error_message: error_message
            exception: exception
            client_id: client_id
            operation: operation

      - labels:
          level:
          logger:
          error_type:
          operation:

      - timestamp:
          source: timestamp
          format: RFC3339Nano

      - output:
          source: message

  # ============================================
  # Kafka Connect Specific Parsing
  # ============================================
  - job_name: kafka-connect-logs
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["kafka-connect"]
    
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
      - replacement: 'kafka-connect'
        target_label: 'service'

    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
      
      # Parse Kafka Connect log format
      - regex:
          source: output
          expression: '^\[(?P<timestamp>[\d-]+\s+[\d:,]+)\]\s+(?P<level>TRACE|DEBUG|INFO|WARN|ERROR)\s+(?P<logger>[\w\.]+)\s+-\s+(?P<message>.*)$'
      
      - labels:
          level:
          logger:
      
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05,000'
      
      - output:
          source: message

  # ============================================
  # Kafka Broker Logs
  # ============================================
  - job_name: kafka-broker-logs
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["kafka-1", "kafka-2", "kafka-3"]
    
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
      - source_labels: ['__meta_docker_container_name']
        regex: '/(kafka-[123])'
        target_label: 'broker_id'
      - replacement: 'kafka'
        target_label: 'service'

    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
      
      # Parse Kafka log format
      - regex:
          source: output
          expression: '^\[(?P<timestamp>[\d-]+\s+[\d:,]+)\]\s+(?P<level>TRACE|DEBUG|INFO|WARN|ERROR|FATAL)\s+(?P<message>.*)$'
      
      - labels:
          level:
      
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05,000'
      
      - output:
          source: message

  # ============================================
  # MySQL Logs
  # ============================================
  - job_name: mysql-logs
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["mysql_wsl"]
    
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
      - replacement: 'mysql'
        target_label: 'service'

    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
      
      # Parse MySQL log format
      - regex:
          source: output
          expression: '^(?P<timestamp>[\d-]+T[\d:\.]+Z)\s+(?P<thread>\d+)\s+\[(?P<level>\w+)\]\s+(\[(?P<subsystem>[\w\.]+)\]\s+)?(?P<message>.*)$'
      
      - labels:
          level:
          subsystem:
      
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      - output:
          source: message

  # ============================================
  # Redis Logs
  # ============================================
  - job_name: redis-logs
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ["redis"]
    
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'
      - replacement: 'redis'
        target_label: 'service'

    pipeline_stages:
      - json:
          expressions:
            output: log
            stream: stream
      
      # Parse Redis log format
      - regex:
          source: output
          expression: '^(?P<pid>\d+):(?P<role>\w)\s+(?P<timestamp>[\d]+\s+[\w]+\s+[\d]+\s+[\d:]+)\s+(?P<level>[\.\*\-#])\s+(?P<message>.*)$'
      
      # Map Redis log symbols to levels
      - replace:
          expression: '^\.$'
          source: level
          target: level
          replace: 'DEBUG'
      
      - replace:
          expression: '^\*$'
          source: level
          target: level
          replace: 'INFO'
      
      - replace:
          expression: '^-$'
          source: level
          target: level
          replace: 'WARNING'
      
      - replace:
          expression: '^#$'
          source: level
          target: level
          replace: 'ERROR'
      
      - labels:
          level:
          role:
      
      - output:
          source: message