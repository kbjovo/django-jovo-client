{% extends "base.html" %}
{% load static %}

{% block title %}Monitor - {{ replication_config.connector_name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="{ deleteModal: { open: false, pk: null, name: '', tables: 0, confirmed: false, truncate: false, drop: false, loading: false } }">

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Connector Monitor</h2>
      <p class="text-gray-600 dark:text-gray-400 mt-1">
        <span class="font-mono text-sm">{{ replication_config.connector_name }}</span>
        &middot; {{ client.name }} &middot; {{ database.connection_name }}
      </p>
    </div>
    <div class="flex gap-2" x-data="{ actionsOpen: false }">
      <!-- Actions Dropdown -->
      <div class="relative">
        <button @click="actionsOpen = !actionsOpen" @click.outside="actionsOpen = false"
          class="inline-flex items-center px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm transition">
          Actions
          <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <div x-show="actionsOpen" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
          x-cloak style="right: 0; left: auto;" class="absolute mt-2 w-auto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 py-1">

          <!-- Edit -->
          <a href="{% url 'connector_edit_tables' replication_config.pk %}"
            class="flex items-center px-4 py-2 text-sm whitespace-nowrap text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
            <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Edit Tables & Settings
          </a>

          <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>

          <!-- Recreate Connector -->
          <button @click="document.getElementById('recreateModal').classList.remove('hidden'); actionsOpen = false"
            class="w-full flex items-center px-4 py-2 text-sm whitespace-nowrap text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
            <svg class="w-4 h-4 mr-3 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Recreate Connector
          </button>

          <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>

          <!-- Delete Connector -->
          <button @click="deleteModal = { open: true, pk: {{ replication_config.pk }}, name: '{{ replication_config.connector_name }}', tables: {{ enabled_table_mappings.count }}, confirmed: false, truncate: false, drop: false, loading: false }; actionsOpen = false"
            class="w-full flex items-center px-4 py-2 text-sm whitespace-nowrap text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
            <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Delete Connector
          </button>
        </div>
      </div>

      <a href="{% url 'connector_list' database.pk %}"
         class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 text-white rounded-lg transition text-sm font-medium">
        &larr; Back to Connectors
      </a>
    </div>
  </div>

  <!-- Status Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">

    <!-- Source Connector Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-visible" x-data="{ srcMenu: false }">
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100 dark:border-gray-700">
        <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Source Connector</p>
        <div class="flex items-center gap-2">
          <span id="source-state" class="text-sm font-bold {% if source_state == 'RUNNING' %}text-green-600 dark:text-green-400{% elif source_state == 'PAUSED' %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
            {{ source_state }}
          </span>
          <div class="relative">
            <button @click="srcMenu = !srcMenu" @click.outside="srcMenu = false"
              class="p-1.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
              </svg>
            </button>
            <div x-show="srcMenu" x-transition x-cloak
              class="absolute right-0 mt-1 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 py-1">
              <button id="btn-src-pause" @click="connectorAction('{% url 'connector_pause' replication_config.pk %}', 'Pausing...'); srcMenu = false"
                class="{% if source_state != 'RUNNING' %}hidden {% endif %}w-full text-left px-3 py-1.5 text-xs text-yellow-700 dark:text-yellow-400 hover:bg-yellow-50 dark:hover:bg-yellow-900/20">
                Pause
              </button>
              <button id="btn-src-resume" @click="connectorAction('{% url 'connector_resume' replication_config.pk %}', 'Resuming...'); srcMenu = false"
                class="{% if source_state != 'PAUSED' %}hidden {% endif %}w-full text-left px-3 py-1.5 text-xs text-green-700 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20">
                Resume
              </button>
              <button @click="connectorAction('{% url 'connector_restart' replication_config.pk %}', 'Restarting...'); srcMenu = false"
                class="w-full text-left px-3 py-1.5 text-xs text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                Restart Connector
              </button>
              <button id="btn-src-restart-failed" @click="connectorAction('{% url 'connector_restart_failed_tasks' replication_config.pk %}', 'Restarting failed...'); srcMenu = false"
                class="hidden w-full text-left px-3 py-1.5 text-xs text-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                Restart Failed Tasks
              </button>
              <button @click="connectorAction('{% url 'connector_restart_all_tasks' replication_config.pk %}', 'Restarting all...'); srcMenu = false"
                class="w-full text-left px-3 py-1.5 text-xs text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                Restart All Tasks
              </button>
              {% if replication_config.processing_mode == 'batch' %}
              <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>
              <button id="btn-sync-schedule" @click="connectorAction('{% url 'connector_sync_schedule' replication_config.pk %}', 'Syncing...'); srcMenu = false"
                class="w-full text-left px-3 py-1.5 text-xs text-purple-700 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20">
                Sync with Schedule
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div id="source-tasks" class="px-4 py-2 space-y-1">
        {% for task in source_tasks %}
        <div class="flex items-center justify-between text-xs px-2 py-1 rounded {% if task.state == 'RUNNING' %}bg-green-50 dark:bg-green-900/10{% elif task.state == 'PAUSED' %}bg-yellow-50 dark:bg-yellow-900/10{% else %}bg-red-50 dark:bg-red-900/10{% endif %}">
          <span class="text-gray-600 dark:text-gray-400">Task {{ task.id }}</span>
          <span class="font-medium {% if task.state == 'RUNNING' %}text-green-700 dark:text-green-400{% elif task.state == 'PAUSED' %}text-yellow-700 dark:text-yellow-400{% else %}text-red-700 dark:text-red-400{% endif %}">{{ task.state }}</span>
        </div>
        {% empty %}
        <p class="text-xs text-gray-400 dark:text-gray-500 italic">No tasks</p>
        {% endfor %}
      </div>
    </div>

    <!-- Sink Connector Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-visible" x-data="{ sinkMenu: false }">
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100 dark:border-gray-700">
        <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
          Sink Connector <span class="text-[10px] font-normal normal-case">(shared)</span>
        </p>
        <div class="flex items-center gap-2">
          <span id="sink-state" class="text-sm font-bold {% if sink_state == 'RUNNING' %}text-green-600 dark:text-green-400{% elif sink_state == 'PAUSED' %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
            {{ sink_state }}
          </span>
          <div class="relative">
            <button @click="sinkMenu = !sinkMenu" @click.outside="sinkMenu = false"
              class="p-1.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
              </svg>
            </button>
            <div x-show="sinkMenu" x-transition x-cloak
              style="right: 0; left: auto;" class="absolute mt-1 w-auto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 py-1">
              <button @click="connectorAction('{% url 'sink_restart' replication_config.pk %}', 'Restarting sink...'); sinkMenu = false"
                class="w-full text-left px-3 py-1.5 text-xs whitespace-nowrap text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                Restart Connector
              </button>
              <button id="btn-sink-restart-failed" @click="connectorAction('{% url 'sink_restart_failed_tasks' replication_config.pk %}', 'Restarting failed...'); sinkMenu = false"
                class="hidden w-full text-left px-3 py-1.5 text-xs whitespace-nowrap text-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                Restart Failed Tasks
              </button>
              <button @click="connectorAction('{% url 'sink_restart_all_tasks' replication_config.pk %}', 'Restarting all...'); sinkMenu = false"
                class="w-full text-left px-3 py-1.5 text-xs whitespace-nowrap text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                Restart All Tasks
              </button>
              <div class="border-t border-gray-100 dark:border-gray-700 mt-1 pt-1 px-3 pb-1">
                <p class="text-[10px] text-gray-400 dark:text-gray-500">Affects all connectors sharing this sink</p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div id="sink-tasks" class="px-4 py-2 space-y-1">
        {% for task in sink_tasks %}
        <div class="flex items-center justify-between text-xs px-2 py-1 rounded {% if task.state == 'RUNNING' %}bg-green-50 dark:bg-green-900/10{% elif task.state == 'PAUSED' %}bg-yellow-50 dark:bg-yellow-900/10{% else %}bg-red-50 dark:bg-red-900/10{% endif %}">
          <span class="text-gray-600 dark:text-gray-400">Task {{ task.id }}</span>
          <span class="font-medium {% if task.state == 'RUNNING' %}text-green-700 dark:text-green-400{% elif task.state == 'PAUSED' %}text-yellow-700 dark:text-yellow-400{% else %}text-red-700 dark:text-red-400{% endif %}">{{ task.state }}</span>
        </div>
        {% empty %}
        <p class="text-xs text-gray-400 dark:text-gray-500 italic">No tasks</p>
        {% endfor %}
      </div>
    </div>

  </div>

  <!-- Task Health Bar -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow px-4 py-2 mb-6 flex items-center justify-between text-xs">
    <div class="flex items-center gap-4">
      <span class="text-gray-500 dark:text-gray-400">Task Health:</span>
      <span id="task-health-status" class="font-bold {% if unified_status.overall == 'healthy' %}text-green-600 dark:text-green-400{% elif unified_status.overall == 'degraded' %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
        {% if unified_status.overall == 'healthy' %}All Running{% elif unified_status.overall == 'degraded' %}Degraded{% else %}Failed{% endif %}
      </span>
    </div>
    <div class="flex items-center gap-3 text-gray-500 dark:text-gray-400">
      <span>{{ enabled_table_mappings.count }} table{{ enabled_table_mappings.count|pluralize }}</span>
      <span>{{ replication_config.get_processing_mode_display }}</span>
    </div>
  </div>

  <!-- Snapshot Progress Panel (shown/hidden by JS) -->
  <div id="snapshot-panel" class="{% if not snapshot %}hidden{% endif %} mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center gap-3">
        <div id="snapshot-spinner" class="animate-spin h-5 w-5 border-2 border-blue-500 border-t-transparent rounded-full"></div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          <span id="snapshot-title">
            {% if snapshot %}
              {% if snapshot.type == 'initial' %}Initial Snapshot{% else %}Incremental Snapshot{% endif %}
            {% else %}
              Snapshot
            {% endif %}
          </span>
        </h3>
        <span id="snapshot-badge" class="ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
          {% if snapshot.running %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400
          {% elif snapshot.completed %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400
          {% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400{% endif %}">
          {% if snapshot.running %}Running{% elif snapshot.completed %}Complete{% else %}--{% endif %}
        </span>
      </div>
      <div class="p-6">
        <!-- Progress Bar -->
        <div class="mb-4">
          <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
            <span>Tables: <span id="snap-done">{{ snapshot.completed_tables|default:"0" }}</span> / <span id="snap-total">{{ snapshot.total_tables|default:"0" }}</span></span>
            <span id="snap-pct">
              {% if snapshot and snapshot.total_tables %}
                {{ snapshot.completed_tables|default:0 }}%
              {% else %}
                0%
              {% endif %}
            </span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
            <div id="snap-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: {% if snapshot and snapshot.total_tables %}{% widthratio snapshot.completed_tables snapshot.total_tables 100 %}%{% else %}0%{% endif %}"></div>
          </div>
        </div>

        <!-- Snapshot Details Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
          <div>
            <p class="text-gray-500 dark:text-gray-400">Rows Scanned</p>
            <p id="snap-rows" class="font-semibold text-gray-900 dark:text-white">{{ snapshot.total_rows_scanned|default:"0" }}</p>
          </div>
          <div>
            <p class="text-gray-500 dark:text-gray-400">Duration</p>
            <p id="snap-duration" class="font-semibold text-gray-900 dark:text-white">{{ snapshot.duration_seconds|default:"0" }}s</p>
          </div>
          <div>
            <p class="text-gray-500 dark:text-gray-400">Current Table</p>
            <p id="snap-current" class="font-semibold text-gray-900 dark:text-white font-mono truncate" title="{{ snapshot.current_table|default:'' }}">{{ snapshot.current_table|default:"--" }}</p>
          </div>
          <div>
            <p class="text-gray-500 dark:text-gray-400">Remaining</p>
            <p id="snap-remaining" class="font-semibold text-gray-900 dark:text-white"><span id="snap-remain-val">{{ snapshot.remaining_tables|default:"0" }}</span> tables</p>
          </div>
        </div>

        <!-- Per-table rows scanned (collapsible) - only for non-batch connectors -->
        {% if replication_config.processing_mode != 'batch' %}
        <details id="snap-rows-detail" class="mt-4 {% if not snapshot.rows_scanned %}hidden{% endif %}">
          <summary class="text-sm text-gray-500 dark:text-gray-400 cursor-pointer hover:text-gray-700 dark:hover:text-gray-300">Rows per table</summary>
          <div id="snap-rows-table" class="mt-2 space-y-1 text-sm font-mono">
            {% if snapshot.rows_scanned %}
              {% for table, count in snapshot.rows_scanned.items %}
                <div class="flex justify-between px-2 py-1 bg-gray-50 dark:bg-gray-900 rounded">
                  <span class="text-gray-700 dark:text-gray-300 truncate">{{ table }}</span>
                  <span class="text-gray-900 dark:text-white font-semibold">{{ count }}</span>
                </div>
              {% endfor %}
            {% endif %}
          </div>
        </details>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Batch Schedule Panel (only for batch connectors) -->
  {% if replication_config.processing_mode == 'batch' %}
  <div id="batch-panel" class="mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-6">
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="batch-status-badge" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400">Scheduled</span>
          </div>
          <div class="flex items-center gap-1">
            <span id="batch-countdown-label" class="text-sm text-gray-500 dark:text-gray-400">Next sync in</span>
            <span id="batch-countdown" class="text-sm font-bold text-purple-600 dark:text-purple-400 font-mono">--:--:--</span>
          </div>
          <span class="text-xs text-gray-400 dark:text-gray-500">|</span>
          <div class="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400">
            <span>Interval: <span id="batch-interval" class="font-medium text-gray-700 dark:text-gray-300">{{ replication_config.get_batch_interval_display|default:"--" }}</span></span>
            <span>Max: <span id="batch-max-duration" class="font-medium text-gray-700 dark:text-gray-300">{{ replication_config.batch_max_catchup_minutes }}m</span></span>
            <span>Last: <span id="batch-last-run" class="font-medium text-gray-700 dark:text-gray-300">{% if replication_config.last_batch_run %}{{ replication_config.last_batch_run|timesince }} ago{% else %}Never{% endif %}</span></span>
            <span>Next: <span id="batch-next-run" class="font-medium text-gray-700 dark:text-gray-300">{% if replication_config.next_batch_run %}{{ replication_config.next_batch_run|date:"M d, g:i A" }}{% else %}--{% endif %}</span></span>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}


  {% if replication_config.processing_mode == 'batch' %}
  <!-- Rows Per Table (accordion) -->
  <div id="batch-rows-panel" class="mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow" x-data="{ rowsOpen: false }">
      <button @click="rowsOpen = !rowsOpen" class="w-full px-6 py-4 flex items-center justify-between hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-lg transition">
        <div class="flex items-center gap-3">
          <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
          </svg>
          <span class="text-sm font-semibold text-gray-900 dark:text-white">Rows Per Table</span>
          <span id="batch-rows-count" class="text-xs text-gray-500 dark:text-gray-400"></span>
        </div>
        <svg class="w-4 h-4 text-gray-400 transition-transform" :class="rowsOpen ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
      <div x-show="rowsOpen" x-collapse x-cloak>
        <div class="px-6 pb-4">
          <div id="batch-rows-table" class="space-y-1 text-sm font-mono">
            <p class="text-gray-400 dark:text-gray-500 text-center py-2">Waiting for data...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Connector Information -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Connector Info</h3>
      </div>
      <div class="p-6 space-y-3 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Connector Name</span>
          <span class="font-mono text-gray-900 dark:text-white">{{ replication_config.connector_name }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Version</span>
          <span class="text-gray-900 dark:text-white">v{{ replication_config.connector_version }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Topic Prefix</span>
          <span class="font-mono text-gray-900 dark:text-white">{{ replication_config.kafka_topic_prefix }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Processing Mode</span>
          <span class="text-gray-900 dark:text-white">{{ replication_config.processing_mode|upper }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Snapshot Mode</span>
          <span class="text-gray-900 dark:text-white">{{ replication_config.snapshot_mode }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Last Sync</span>
          <span class="text-gray-900 dark:text-white">{{ replication_config.last_sync_at|date:"M d, Y g:i A"|default:"Never" }}</span>
        </div>
      </div>
    </div>

    <!-- Statistics -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Statistics</h3>
      </div>
      <div class="p-6 space-y-3 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Total Rows Synced</span>
          <span id="stat-rows" class="font-semibold text-gray-900 dark:text-white">{{ unified_status.statistics.total_rows_synced|default:"0" }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Tables Enabled</span>
          <span class="text-gray-900 dark:text-white">{{ unified_status.statistics.tables_enabled }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Sink Connector</span>
          <span class="font-mono text-gray-900 dark:text-white">{{ replication_config.sink_connector_name|default:"--" }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Database Type</span>
          <span class="text-gray-900 dark:text-white">{{ database.db_type|upper }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Host</span>
          <span class="font-mono text-gray-900 dark:text-white">{{ database.host }}:{{ database.port }}</span>
        </div>
      </div>
    </div>
  </div>


  <!-- Delete Modal -->
  {% include "client/connectors/_delete_modal.html" %}

</div>

<!-- Recreate Connector Modal -->
<div id="recreateModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
  <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md mx-4">
    <div class="flex items-center mb-4">
      <svg class="h-6 w-6 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
      </svg>
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Recreate Source Connector</h3>
    </div>
    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">
      This will delete and recreate the source connector while keeping everything else intact:
    </p>
    <ul class="text-sm text-gray-600 dark:text-gray-400 mb-4 list-disc list-inside space-y-1">
      <li>Same version (v{{ replication_config.connector_version }})</li>
      <li>Same Kafka topics ({{ replication_config.kafka_topic_prefix }}.*)</li>
      <li>Sink connector untouched</li>
      <li>Target tables untouched</li>
    </ul>

    <form method="post" action="{% url 'connector_recreate' replication_config.pk %}">
      {% csrf_token %}

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Snapshot Mode</label>
        <div class="space-y-2">
          <label class="flex items-start gap-2 cursor-pointer">
            <input type="radio" name="snapshot_mode" value="when_needed" checked
              class="mt-1 text-blue-600 focus:ring-blue-500">
            <div>
              <span class="text-sm font-medium text-gray-900 dark:text-white">Resume from offset</span>
              <p class="text-xs text-gray-500 dark:text-gray-400">Continues from where it left off. No re-snapshot unless offsets are missing.</p>
            </div>
          </label>
          <label class="flex items-start gap-2 cursor-pointer">
            <input type="radio" name="snapshot_mode" value="initial"
              class="mt-1 text-blue-600 focus:ring-blue-500">
            <div>
              <span class="text-sm font-medium text-gray-900 dark:text-white">Full re-snapshot</span>
              <p class="text-xs text-gray-500 dark:text-gray-400">Re-reads all existing data from source. Use if data is out of sync.</p>
            </div>
          </label>
        </div>
      </div>

      <p class="text-sm text-blue-600 dark:text-blue-400 mb-4">
        <strong>Use this when:</strong> The connector is FAILED or stuck, and you want a fresh connector without losing topics or target data.
      </p>
      <div class="flex justify-end gap-3">
        <button type="button"
          onclick="document.getElementById('recreateModal').classList.add('hidden')"
          class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
          Cancel
        </button>
        <button type="submit"
          class="px-4 py-2 border border-transparent rounded-lg text-sm font-medium text-white bg-blue-600 hover:bg-blue-700">
          Recreate Connector
        </button>
      </div>
    </form>
  </div>
</div>

<!-- AJAX Polling Script -->
<script>
// CSRF token for POST requests
const CSRF_TOKEN = '{{ csrf_token }}';

function connectorAction(url, loadingMsg) {
  showToast('info', loadingMsg);

  fetch(url, {
    method: 'POST',
    headers: { 'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json' },
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showToast('success', data.message || 'Success');
    } else {
      showToast('error', data.message || data.error || 'Failed');
    }
    setTimeout(pollNow, 500);
  })
  .catch(err => {
    showToast('error', 'Request failed');
  });
}

(function() {
  const STATUS_URL = '{% url "connector_status_api" replication_config.pk %}';
  const POLL_INTERVAL = 5000;
  const IDLE_INTERVAL = 30000;
  let currentInterval = POLL_INTERVAL;
  let timer = null;

  // Batch schedule state
  let batchNextRun = null;   // Date object
  let batchLastRun = null;   // Date object
  let batchSyncing = false;  // true when source connector is RUNNING in batch mode
  let batchSyncStart = null; // Date when sync started
  let countdownTimer = null;
  const isBatch = '{{ replication_config.processing_mode }}' === 'batch';

  function formatNumber(n) {
    return Number(n || 0).toLocaleString();
  }

  function stateColor(state) {
    if (state === 'RUNNING') return 'text-green-600 dark:text-green-400';
    if (state === 'PAUSED') return 'text-yellow-600 dark:text-yellow-400';
    return 'text-red-600 dark:text-red-400';
  }

  function healthColor(h) {
    if (h === 'healthy') return 'text-green-600 dark:text-green-400';
    return 'text-red-600 dark:text-red-400';
  }

  function formatDuration(totalSeconds) {
    if (totalSeconds <= 0) return '00:00';
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    const pad = v => String(v).padStart(2, '0');
    return h > 0 ? pad(h) + ':' + pad(m) + ':' + pad(s) : pad(m) + ':' + pad(s);
  }

  function timeAgo(date) {
    if (!date) return 'Never';
    const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
    if (seconds < 60) return seconds + 's ago';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return minutes + 'm ago';
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'h ' + (minutes % 60) + 'm ago';
    const days = Math.floor(hours / 24);
    return days + 'd ago';
  }

  function updateBatchCountdown() {
    const label = document.getElementById('batch-countdown-label');
    const display = document.getElementById('batch-countdown');
    const badge = document.getElementById('batch-status-badge');
    if (!label || !display) return;

    if (batchSyncing) {
      // Show elapsed sync time
      label.textContent = 'Syncing...';
      const elapsed = Math.floor((Date.now() - (batchSyncStart || Date.now())) / 1000);
      display.textContent = formatDuration(elapsed);
      display.className = 'text-3xl font-bold text-green-600 dark:text-green-400 font-mono';
      badge.textContent = 'Syncing';
      badge.className = 'ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400';
    } else if (batchNextRun) {
      // Show countdown to next run
      const remaining = Math.max(0, Math.floor((batchNextRun.getTime() - Date.now()) / 1000));
      label.textContent = 'Next sync in';
      display.textContent = formatDuration(remaining);
      display.className = 'text-3xl font-bold text-purple-600 dark:text-purple-400 font-mono';
      badge.textContent = 'Scheduled';
      badge.className = 'ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400';

      if (remaining <= 0) {
        display.textContent = '00:00';
        label.textContent = 'Starting soon...';
      }
    } else {
      label.textContent = 'Next sync';
      display.textContent = '--:--';
      display.className = 'text-3xl font-bold text-gray-400 dark:text-gray-500 font-mono';
      badge.textContent = 'No schedule';
      badge.className = 'ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400';
    }

    // Update last synced (keeps ticking)
    const lastRunEl = document.getElementById('batch-last-run');
    if (lastRunEl) lastRunEl.textContent = timeAgo(batchLastRun);
  }

  function updateBatchSchedule(s) {
    const batch = s.batch_schedule;
    if (!batch) return;

    // Determine if currently syncing (source connector RUNNING in batch mode = active sync)
    const sourceState = s.source_connector.state;
    const wasSyncing = batchSyncing;
    batchSyncing = sourceState === 'RUNNING';

    if (batchSyncing && !wasSyncing) {
      batchSyncStart = new Date();
    } else if (!batchSyncing) {
      batchSyncStart = null;
    }

    // Update schedule timestamps
    batchNextRun = batch.next_batch_run ? new Date(batch.next_batch_run) : null;
    batchLastRun = batch.last_batch_run ? new Date(batch.last_batch_run) : null;

    // Update static fields
    const intervalEl = document.getElementById('batch-interval');
    if (intervalEl) intervalEl.textContent = batch.batch_interval_display || '--';

    const maxEl = document.getElementById('batch-max-duration');
    if (maxEl) maxEl.textContent = batch.batch_max_catchup_minutes + ' min';

    const nextRunEl = document.getElementById('batch-next-run');
    if (nextRunEl && batchNextRun) {
      nextRunEl.textContent = batchNextRun.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ', ' +
        batchNextRun.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    // Update schedule status badge
    const badge = document.getElementById('batch-status-badge');
    if (badge) {
      if (batchSyncing) {
        badge.textContent = 'Syncing';
        badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400';
      } else if (batch.is_on_schedule) {
        badge.textContent = 'Scheduled';
        badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400';
      } else {
        badge.textContent = 'Off Schedule';
        badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400';
      }
    }

    updateBatchCountdown();
  }

  function taskBgClass(state) {
    if (state === 'RUNNING') return 'bg-green-50 dark:bg-green-900/10';
    if (state === 'PAUSED') return 'bg-yellow-50 dark:bg-yellow-900/10';
    return 'bg-red-50 dark:bg-red-900/10';
  }

  function taskTextClass(state) {
    if (state === 'RUNNING') return 'text-green-700 dark:text-green-400';
    if (state === 'PAUSED') return 'text-yellow-700 dark:text-yellow-400';
    return 'text-red-700 dark:text-red-400';
  }

  function renderTasks(containerId, tasks) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (!tasks || tasks.length === 0) {
      container.innerHTML = '<p class="text-xs text-gray-400 dark:text-gray-500 italic">No tasks</p>';
      return;
    }

    container.innerHTML = tasks.map(t => {
      const state = t.state || 'UNKNOWN';
      const trace = t.trace ? ` title="${t.trace.substring(0, 200).replace(/"/g, '&quot;')}"` : '';
      return `<div class="flex items-center justify-between text-xs px-2 py-1 rounded ${taskBgClass(state)}"${trace}>
        <span class="text-gray-600 dark:text-gray-400">Task ${t.id}</span>
        <span class="font-medium ${taskTextClass(state)}">${state}</span>
      </div>`;
    }).join('');
  }

  function updateStatus(data) {
    const s = data.status;

    // Source connector state + tasks
    const srcEl = document.getElementById('source-state');
    srcEl.textContent = s.source_connector.state;
    srcEl.className = 'text-sm font-bold ' + stateColor(s.source_connector.state);
    renderTasks('source-tasks', s.source_connector.tasks);

    // Sink connector state + tasks
    const sinkEl = document.getElementById('sink-state');
    sinkEl.textContent = s.sink_connector.state;
    sinkEl.className = 'text-sm font-bold ' + stateColor(s.sink_connector.state);
    renderTasks('sink-tasks', s.sink_connector.tasks);

    // Task health bar
    const allTasks = [...(s.source_connector.tasks || []), ...(s.sink_connector.tasks || [])];
    const hasFailed = allTasks.some(t => t.state === 'FAILED');
    const allRunning = allTasks.length > 0 && allTasks.every(t => t.state === 'RUNNING');
    const allPaused = allTasks.length > 0 && allTasks.every(t => t.state === 'PAUSED');

    const healthEl = document.getElementById('task-health-status');
    if (healthEl) {
      if (hasFailed) {
        healthEl.textContent = 'Failed';
        healthEl.className = 'font-bold text-red-600 dark:text-red-400';
      } else if (allPaused) {
        healthEl.textContent = 'All Paused';
        healthEl.className = 'font-bold text-yellow-600 dark:text-yellow-400';
      } else if (allRunning) {
        healthEl.textContent = 'All Running';
        healthEl.className = 'font-bold text-green-600 dark:text-green-400';
      } else {
        healthEl.textContent = s.overall.charAt(0).toUpperCase() + s.overall.slice(1);
        healthEl.className = 'font-bold ' + healthColor(s.overall);
      }
    }

    // Statistics
    document.getElementById('stat-rows').textContent = formatNumber(s.statistics.total_rows_synced);

    // Update action button visibility
    updateActionButtons(s);

    // Batch schedule update
    if (isBatch && s.batch_schedule) {
      updateBatchSchedule(s);
    }

    // Update persistent rows-per-table panel for batch connectors
    if (isBatch && s.snapshot && s.snapshot.rows_scanned) {
      updateBatchRowsTable(s.snapshot.rows_scanned);
    }

    // Snapshot panel
    const panel = document.getElementById('snapshot-panel');
    const snap = s.snapshot;

    if (snap && (snap.running || snap.completed)) {
      panel.classList.remove('hidden');

      const typeLabel = snap.type === 'initial' ? 'Initial Snapshot' : 'Incremental Snapshot';
      document.getElementById('snapshot-title').textContent = typeLabel;

      const badge = document.getElementById('snapshot-badge');
      if (snap.running) {
        badge.textContent = 'Running';
        badge.className = 'ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400';
        document.getElementById('snapshot-spinner').classList.remove('hidden');
      } else if (snap.completed) {
        badge.textContent = 'Complete';
        badge.className = 'ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400';
        document.getElementById('snapshot-spinner').classList.add('hidden');
      }

      const done = snap.completed_tables || 0;
      const total = snap.total_tables || 0;
      const pct = total > 0 ? Math.round((done / total) * 100) : 0;

      document.getElementById('snap-done').textContent = done;
      document.getElementById('snap-total').textContent = total;
      document.getElementById('snap-pct').textContent = pct + '%';
      document.getElementById('snap-bar').style.width = pct + '%';

      document.getElementById('snap-rows').textContent = formatNumber(snap.total_rows_scanned);
      document.getElementById('snap-duration').textContent = (snap.duration_seconds || 0) + 's';
      document.getElementById('snap-current').textContent = snap.current_table || '--';
      document.getElementById('snap-current').title = snap.current_table || '';
      document.getElementById('snap-remain-val').textContent = snap.remaining_tables || 0;

      // Update snapshot rows detail only for non-batch connectors
      // Batch connectors use the permanent "Rows Per Table" panel
      if (!isBatch) {
        const rowsDetail = document.getElementById('snap-rows-detail');
        const rowsTable = document.getElementById('snap-rows-table');
        if (rowsDetail && rowsTable && snap.rows_scanned && Object.keys(snap.rows_scanned).length > 0) {
          rowsDetail.classList.remove('hidden');
          rowsTable.innerHTML = '';
          for (const [table, count] of Object.entries(snap.rows_scanned)) {
            const row = document.createElement('div');
            row.className = 'flex justify-between px-2 py-1 bg-gray-50 dark:bg-gray-900 rounded';
            row.innerHTML = '<span class="text-gray-700 dark:text-gray-300 truncate">' + table + '</span>'
              + '<span class="text-gray-900 dark:text-white font-semibold">' + formatNumber(count) + '</span>';
            rowsTable.appendChild(row);
          }
        }
      }

      currentInterval = snap.running ? POLL_INTERVAL : IDLE_INTERVAL;
    } else {
      if (!snap || (!snap.running && !snap.completed)) {
        panel.classList.add('hidden');
      }
      currentInterval = batchSyncing ? POLL_INTERVAL : IDLE_INTERVAL;
    }
  }

  function toggleBtn(id, show) {
    const el = document.getElementById(id);
    if (!el) return;
    if (show) el.classList.remove('hidden');
    else el.classList.add('hidden');
  }

  function updateActionButtons(s) {
    const sourceState = s.source_connector.state;
    const sourceTasks = s.source_connector.tasks || [];
    const sinkTasks = s.sink_connector.tasks || [];

    // Source: Pause when RUNNING, Resume when PAUSED
    toggleBtn('btn-src-pause', sourceState === 'RUNNING');
    toggleBtn('btn-src-resume', sourceState === 'PAUSED');

    // Source: Restart Failed visible when any source task FAILED
    toggleBtn('btn-src-restart-failed', sourceTasks.some(t => t.state === 'FAILED'));

    // Sink: Restart Failed visible when any sink task FAILED
    toggleBtn('btn-sink-restart-failed', sinkTasks.some(t => t.state === 'FAILED'));

    // Sync with Schedule: hide when on schedule and paused
    const btnSyncSchedule = document.getElementById('btn-sync-schedule');
    if (btnSyncSchedule && s.batch_schedule) {
      if (s.batch_schedule.is_on_schedule && sourceState === 'PAUSED') {
        btnSyncSchedule.classList.add('hidden');
      } else {
        btnSyncSchedule.classList.remove('hidden');
      }
    }
  }

  function updateBatchRowsTable(rowsScanned) {
    const container = document.getElementById('batch-rows-table');
    const countEl = document.getElementById('batch-rows-count');
    if (!container) return;

    const entries = Object.entries(rowsScanned);
    if (entries.length === 0) return;

    if (countEl) countEl.textContent = entries.length + ' tables';

    container.innerHTML = '';
    for (const [table, count] of entries) {
      const row = document.createElement('div');
      row.className = 'flex justify-between px-2 py-1 bg-gray-50 dark:bg-gray-900 rounded';
      row.innerHTML = '<span class="text-gray-700 dark:text-gray-300 truncate">' + table + '</span>'
        + '<span class="text-gray-900 dark:text-white font-semibold">' + formatNumber(count) + '</span>';
      container.appendChild(row);
    }
  }

  // Expose pollNow for action buttons to trigger immediate refresh
  window.pollNow = function() {
    if (timer) clearTimeout(timer);
    poll();
  };

  function poll() {
    fetch(STATUS_URL)
      .then(r => r.json())
      .then(data => {
        if (data.success) updateStatus(data);
      })
      .catch(err => console.warn('Status poll failed:', err))
      .finally(() => {
        timer = setTimeout(poll, currentInterval);
      });
  }

  // Start polling
  timer = setTimeout(poll, POLL_INTERVAL);

  // Start 1-second countdown ticker for batch mode
  if (isBatch) {
    countdownTimer = setInterval(updateBatchCountdown, 1000);
  }
})();
</script>
{% endblock %}