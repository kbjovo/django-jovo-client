{% extends "base.html" %}
{% load static %}

{% block title %}Monitor - {{ replication_config.connector_name }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="{ deleteModal: { open: false, pk: null, name: '', tables: 0, confirmed: false, truncate: false, drop: false, loading: false } }">

  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div>
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Connector Monitor</h2>
      <p class="text-gray-600 dark:text-gray-400 mt-1 flex items-center gap-2">
        <span class="font-mono text-sm">{{ replication_config.connector_name }}</span>
        {% if replication_config.processing_mode == 'cdc' %}
          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-purple-100 text-purple-700 dark:bg-purple-900/40 dark:text-purple-300">CDC</span>
        {% else %}
          <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold bg-blue-100 text-blue-700 dark:bg-blue-900/40 dark:text-blue-300">Batch</span>
        {% endif %}
        &middot; {{ client.name }} &middot; {{ database.connection_name }}
      </p>
    </div>
    <div class="flex gap-2" x-data="{ actionsOpen: false }">
      <!-- Actions Dropdown -->
      <div class="relative">
        <button @click="actionsOpen = !actionsOpen" @click.outside="actionsOpen = false"
          class="inline-flex items-center px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 shadow-sm transition">
          Actions
          <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <div x-show="actionsOpen" x-transition:enter="transition ease-out duration-100" x-transition:enter-start="opacity-0 scale-95" x-transition:enter-end="opacity-100 scale-100" x-transition:leave="transition ease-in duration-75" x-transition:leave-start="opacity-100 scale-100" x-transition:leave-end="opacity-0 scale-95"
          x-cloak style="right: 0; left: auto;" class="absolute mt-2 w-auto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 py-1">

          <!-- Edit -->
          <a href="{% url 'connector_edit_tables' replication_config.pk %}"
            class="flex items-center px-4 py-2 text-sm whitespace-nowrap text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
            <svg class="w-4 h-4 mr-3 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
            Edit Tables & Settings
          </a>

          <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>

          <!-- Delete Connector -->
          <button @click="deleteModal = { open: true, pk: {{ replication_config.pk }}, name: '{{ replication_config.connector_name }}', tables: {{ enabled_table_mappings.count }}, confirmed: false, truncate: true, drop: false, loading: false }; actionsOpen = false"
            class="w-full flex items-center px-4 py-2 text-sm whitespace-nowrap text-red-600 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
            <svg class="w-4 h-4 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Delete Connector
          </button>
        </div>
      </div>

      <a href="{% url 'connector_list' database.pk %}"
         class="inline-flex items-center px-4 py-2 bg-gray-600 hover:bg-gray-700 dark:bg-gray-700 dark:hover:bg-gray-600 text-white rounded-lg transition text-sm font-medium">
        &larr; Back to Connectors
      </a>
    </div>
  </div>

  <!-- Status Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">

    <!-- Source Connector Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-visible" x-data="{ srcMenu: false }">
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100 dark:border-gray-700">
        <div>
          <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Source Connector</p>
          {% if connector_history %}
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-0.5">Since {{ connector_history.created_at|timesince }}</p>
          {% endif %}
        </div>
        <div class="flex items-center gap-2">
          <span id="source-state" class="text-sm font-bold {% if source_state == 'RUNNING' %}text-green-600 dark:text-green-400{% elif source_state == 'PAUSED' %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
            {{ source_state }}
          </span>
          <div class="relative">
            <button @click="srcMenu = !srcMenu" @click.outside="srcMenu = false"
              class="p-1.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
              </svg>
            </button>
            <div x-show="srcMenu" x-transition x-cloak
              class="absolute right-0 mt-1 w-48 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 py-1">
              <button id="btn-src-pause" @click="connectorAction('{% url 'connector_pause' replication_config.pk %}', 'Pausing...'); srcMenu = false"
                class="{% if source_state != 'RUNNING' %}hidden {% endif %}w-full text-left px-3 py-1.5 text-xs text-yellow-700 dark:text-yellow-400 hover:bg-yellow-50 dark:hover:bg-yellow-900/20">
                Pause
              </button>
              <button id="btn-src-resume" @click="connectorAction('{% url 'connector_resume' replication_config.pk %}', 'Resuming...'); srcMenu = false"
                class="{% if source_state != 'PAUSED' %}hidden {% endif %}w-full text-left px-3 py-1.5 text-xs text-green-700 dark:text-green-400 hover:bg-green-50 dark:hover:bg-green-900/20">
                Resume
              </button>
              <button @click="connectorAction('{% url 'connector_restart' replication_config.pk %}', 'Restarting...'); srcMenu = false"
                class="w-full text-left px-3 py-1.5 text-xs text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                Restart Connector
              </button>
              <button id="btn-src-restart-failed" @click="connectorAction('{% url 'connector_restart_failed_tasks' replication_config.pk %}', 'Restarting failed...'); srcMenu = false"
                class="hidden w-full text-left px-3 py-1.5 text-xs text-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                Restart Failed Tasks
              </button>
              <button @click="connectorAction('{% url 'connector_restart_all_tasks' replication_config.pk %}', 'Restarting all...'); srcMenu = false"
                class="w-full text-left px-3 py-1.5 text-xs text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                Restart All Tasks
              </button>
              {% if replication_config.processing_mode == 'batch' %}
              <div class="border-t border-gray-100 dark:border-gray-700 my-1"></div>
              <button id="btn-sync-schedule" @click="connectorAction('{% url 'connector_sync_schedule' replication_config.pk %}', 'Syncing...'); srcMenu = false"
                class="w-full text-left px-3 py-1.5 text-xs text-purple-700 dark:text-purple-400 hover:bg-purple-50 dark:hover:bg-purple-900/20">
                Sync with Schedule
              </button>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
      <div id="source-tasks" class="px-4 py-2 space-y-1">
        {% for task in source_tasks %}
        <div>
          <div class="flex items-center justify-between text-xs px-2 py-1 rounded {% if task.state == 'RUNNING' %}bg-green-50 dark:bg-green-900/10{% elif task.state == 'PAUSED' %}bg-yellow-50 dark:bg-yellow-900/10{% else %}bg-red-50 dark:bg-red-900/10{% endif %}">
            <span class="text-gray-600 dark:text-gray-400">Task {{ task.id }}</span>
            <span class="font-medium {% if task.state == 'RUNNING' %}text-green-700 dark:text-green-400{% elif task.state == 'PAUSED' %}text-yellow-700 dark:text-yellow-400{% else %}text-red-700 dark:text-red-400{% endif %}">{{ task.state }}</span>
          </div>
          {% if task.state == 'FAILED' and task.trace %}
          <button class="w-full text-left mt-0.5 px-2 py-1.5 bg-red-50 dark:bg-red-900/10 rounded group"
                  onclick="showErrorModal('Task {{ task.id }} — Error Trace', '{{ task.trace|escapejs }}')">
            <p class="text-xs font-mono text-red-600 dark:text-red-400 truncate">{{ task.trace|truncatechars:120 }}</p>
            <p class="text-xs text-red-400 dark:text-red-500 mt-0.5 group-hover:underline">Click to view full trace &rarr;</p>
          </button>
          {% endif %}
        </div>
        {% empty %}
        <p class="text-xs text-gray-400 dark:text-gray-500 italic">No tasks</p>
        {% endfor %}
      </div>
    </div>

    <!-- Sink Connector Card -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-visible" x-data="{ sinkMenu: false }">
      <div class="flex items-center justify-between px-4 py-3 border-b border-gray-100 dark:border-gray-700">
        <div>
          <p class="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
            Sink Connector <span class="text-[10px] font-normal normal-case">(shared)</span>
          </p>
          {% if sink_connector_history %}
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-0.5">Since {{ sink_connector_history.created_at|timesince }}</p>
          {% endif %}
        </div>
        <div class="flex items-center gap-2">
          <span id="sink-state" class="text-sm font-bold {% if sink_state == 'RUNNING' %}text-green-600 dark:text-green-400{% elif sink_state == 'PAUSED' %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
            {{ sink_state }}
          </span>
          <div class="relative">
            <button @click="sinkMenu = !sinkMenu" @click.outside="sinkMenu = false"
              class="p-1.5 rounded hover:bg-gray-100 dark:hover:bg-gray-700 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 transition">
              <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"/>
              </svg>
            </button>
            <div x-show="sinkMenu" x-transition x-cloak
              style="right: 0; left: auto;" class="absolute mt-1 w-auto bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg z-50 py-1">
              <button @click="connectorAction('{% url 'sink_restart' replication_config.pk %}', 'Restarting sink...'); sinkMenu = false"
                class="w-full text-left px-3 py-1.5 text-xs whitespace-nowrap text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                Restart Connector
              </button>
              <button id="btn-sink-restart-failed" @click="connectorAction('{% url 'sink_restart_failed_tasks' replication_config.pk %}', 'Restarting failed...'); sinkMenu = false"
                class="hidden w-full text-left px-3 py-1.5 text-xs whitespace-nowrap text-red-700 dark:text-red-400 hover:bg-red-50 dark:hover:bg-red-900/20">
                Restart Failed Tasks
              </button>
              <button @click="connectorAction('{% url 'sink_restart_all_tasks' replication_config.pk %}', 'Restarting all...'); sinkMenu = false"
                class="w-full text-left px-3 py-1.5 text-xs whitespace-nowrap text-gray-700 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700">
                Restart All Tasks
              </button>
            </div>
          </div>
        </div>
      </div>
      <div id="sink-tasks" class="px-4 py-2 space-y-1">
        {% for task in sink_tasks %}
        <div>
          <div class="flex items-center justify-between text-xs px-2 py-1 rounded {% if task.state == 'RUNNING' %}bg-green-50 dark:bg-green-900/10{% elif task.state == 'PAUSED' %}bg-yellow-50 dark:bg-yellow-900/10{% else %}bg-red-50 dark:bg-red-900/10{% endif %}">
            <span class="text-gray-600 dark:text-gray-400">Task {{ task.id }}</span>
            <span class="font-medium {% if task.state == 'RUNNING' %}text-green-700 dark:text-green-400{% elif task.state == 'PAUSED' %}text-yellow-700 dark:text-yellow-400{% else %}text-red-700 dark:text-red-400{% endif %}">{{ task.state }}</span>
          </div>
          {% if task.state == 'FAILED' and task.trace %}
          <button class="w-full text-left mt-0.5 px-2 py-1.5 bg-red-50 dark:bg-red-900/10 rounded group"
                  onclick="showErrorModal('Task {{ task.id }} — Error Trace', '{{ task.trace|escapejs }}')">
            <p class="text-xs font-mono text-red-600 dark:text-red-400 truncate">{{ task.trace|truncatechars:120 }}</p>
            <p class="text-xs text-red-400 dark:text-red-500 mt-0.5 group-hover:underline">Click to view full trace &rarr;</p>
          </button>
          {% endif %}
        </div>
        {% empty %}
        <p class="text-xs text-gray-400 dark:text-gray-500 italic">No tasks</p>
        {% endfor %}
      </div>
    </div>

  </div>

  <!-- Task Health Bar -->
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow px-4 py-2 mb-6 flex items-center justify-between text-xs">
    <div class="flex items-center gap-4">
      <span class="text-gray-500 dark:text-gray-400">Task Health:</span>
      <span id="task-health-status" class="font-bold {% if unified_status.overall == 'healthy' %}text-green-600 dark:text-green-400{% elif unified_status.overall == 'degraded' %}text-yellow-600 dark:text-yellow-400{% else %}text-red-600 dark:text-red-400{% endif %}">
        {% if unified_status.overall == 'healthy' %}All Running{% elif unified_status.overall == 'degraded' %}Degraded{% else %}Failed{% endif %}
      </span>
    </div>
    <div class="flex items-center gap-3 text-gray-500 dark:text-gray-400">
      <span>{{ enabled_table_mappings.count }} table{{ enabled_table_mappings.count|pluralize }}</span>
      <span>{{ replication_config.get_processing_mode_display }}</span>
    </div>
  </div>

  <!-- Error Banner (if last_error_message is set) -->
  {% if replication_config.last_error_message %}
  <button class="w-full text-left mb-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg px-4 py-3 flex gap-3 group hover:bg-red-100 dark:hover:bg-red-900/30 transition"
          onclick="showErrorModal('Last Error — {{ replication_config.connector_name }}', '{{ replication_config.last_error_message|escapejs }}')">
    <svg class="w-5 h-5 text-red-500 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
    </svg>
    <div class="min-w-0 flex-1">
      <p class="text-sm font-semibold text-red-700 dark:text-red-400">Last Error</p>
      <p class="text-xs text-red-600 dark:text-red-300 mt-0.5 truncate font-mono">{{ replication_config.last_error_message }}</p>
      <p class="text-xs text-red-400 dark:text-red-500 mt-1 group-hover:underline">Click to view full error &rarr;</p>
    </div>
  </button>
  {% endif %}

  <!-- Live Metrics Panel (streaming lag, DLQ, queue — polled every 10s) -->
  <div class="mb-4 bg-white dark:bg-gray-800 rounded-lg shadow" x-data="{ metricsOpen: true }">
    <div class="flex items-center justify-between px-4 py-3 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-t-lg transition border-b border-gray-100 dark:border-gray-700"
         @click="metricsOpen = !metricsOpen">
      <div class="flex items-center gap-2">
        <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        <span class="text-sm font-semibold text-gray-900 dark:text-white">Live Metrics</span>
        <span id="metrics-refresh-badge" class="text-xs text-gray-400 dark:text-gray-500 hidden">refreshing…</span>
      </div>
      <div class="flex items-center gap-3">
        <span id="metrics-last-updated" class="text-xs text-gray-400 dark:text-gray-500"></span>
        <svg class="w-4 h-4 text-gray-400 transition-transform" :class="metricsOpen ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </div>
    </div>
    <div x-show="metricsOpen" x-transition>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-0 divide-x divide-y divide-gray-100 dark:divide-gray-700">

        <!-- Lag -->
        <div class="px-4 py-3">
          <p class="text-xs text-gray-500 dark:text-gray-400">Source Lag</p>
          <p id="m-lag" class="text-xl font-bold text-gray-900 dark:text-white mt-0.5">--</p>
          <p class="text-xs text-gray-400 dark:text-gray-500 mt-0.5">behind source</p>
        </div>

        <!-- Queue Utilisation -->
        <div class="px-4 py-3">
          <p class="text-xs text-gray-500 dark:text-gray-400">Queue Utilisation</p>
          <div class="flex items-center gap-2 mt-0.5">
            <p id="m-queue-pct" class="text-xl font-bold text-gray-900 dark:text-white">--</p>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-1.5 mt-1.5">
            <div id="m-queue-bar" class="bg-blue-500 h-1.5 rounded-full transition-all duration-500" style="width:0%"></div>
          </div>
        </div>


      </div>

      <!-- Config Drift Alert -->
      <div id="config-drift-banner" class="hidden px-4 py-2 border-t border-yellow-200 dark:border-yellow-800 bg-yellow-50 dark:bg-yellow-900/20">
        <p class="text-xs font-semibold text-yellow-700 dark:text-yellow-400">Config drift detected — live connector differs from stored settings:</p>
        <ul id="config-drift-list" class="mt-1 space-y-0.5 text-xs font-mono text-yellow-600 dark:text-yellow-300"></ul>
      </div>

      <div id="metrics-unavailable" class="hidden px-4 py-3 border-t border-gray-100 dark:border-gray-700">
        <p class="text-xs text-gray-400 dark:text-gray-500 italic">Streaming metrics unavailable — connector may be in snapshot phase or Jolokia unreachable.</p>
      </div>
    </div>
  </div>

  <!-- Snapshot Progress Panel (shown/hidden by JS) -->
  <div id="snapshot-panel" class="{% if not snapshot %}hidden{% endif %} mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center gap-3">
        <div id="snapshot-spinner" class="animate-spin h-5 w-5 border-2 border-blue-500 border-t-transparent rounded-full"></div>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          <span id="snapshot-title">
            {% if snapshot %}
              {% if snapshot.type == 'initial' %}Initial Snapshot{% else %}Incremental Snapshot{% endif %}
            {% else %}
              Snapshot
            {% endif %}
          </span>
        </h3>
        <span id="snapshot-badge" class="ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
          {% if snapshot.running %}bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400
          {% elif snapshot.completed %}bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400
          {% else %}bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400{% endif %}">
          {% if snapshot.running %}Running{% elif snapshot.completed %}Complete{% else %}--{% endif %}
        </span>
      </div>
      <div class="p-6">
        <!-- Progress Bar -->
        <div class="mb-4">
          <div class="flex justify-between text-sm text-gray-600 dark:text-gray-400 mb-1">
            <span>Tables: <span id="snap-done">{{ snapshot.completed_tables|default:"0" }}</span> / <span id="snap-total">{{ snapshot.total_tables|default:"0" }}</span></span>
            <span id="snap-pct">
              {% if snapshot and snapshot.total_tables %}
                {{ snapshot.completed_tables|default:0 }}%
              {% else %}
                0%
              {% endif %}
            </span>
          </div>
          <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-3">
            <div id="snap-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: {% if snapshot and snapshot.total_tables %}{% widthratio snapshot.completed_tables snapshot.total_tables 100 %}%{% else %}0%{% endif %}"></div>
          </div>
        </div>

        <!-- Snapshot Details Grid -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
          <div>
            <p class="text-gray-500 dark:text-gray-400">Rows Scanned</p>
            <p id="snap-rows" class="font-semibold text-gray-900 dark:text-white">{{ snapshot.total_rows_scanned|default:"0" }}</p>
          </div>
          <div>
            <p class="text-gray-500 dark:text-gray-400">Duration</p>
            <p id="snap-duration" class="font-semibold text-gray-900 dark:text-white">{{ snapshot.duration_seconds|default:"0" }}s</p>
          </div>
          <div>
            <p class="text-gray-500 dark:text-gray-400">Current Table</p>
            <p id="snap-current" class="font-semibold text-gray-900 dark:text-white font-mono truncate" title="{{ snapshot.current_table|default:'' }}">{{ snapshot.current_table|default:"--" }}</p>
          </div>
          <div>
            <p class="text-gray-500 dark:text-gray-400">Remaining</p>
            <p id="snap-remaining" class="font-semibold text-gray-900 dark:text-white"><span id="snap-remain-val">{{ snapshot.remaining_tables|default:"0" }}</span> tables</p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Batch Schedule Panel (only for batch connectors) -->
  {% if replication_config.processing_mode == 'batch' %}
  <div id="batch-panel" class="mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow px-6 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-6">
          <div class="flex items-center gap-2">
            <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="batch-status-badge" class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400">Scheduled</span>
          </div>
          <div class="flex items-center gap-1">
            <span id="batch-countdown-label" class="text-sm text-gray-500 dark:text-gray-400">Next sync in</span>
            <span id="batch-countdown" class="text-sm font-bold text-purple-600 dark:text-purple-400 font-mono">--:--:--</span>
          </div>
          <span class="text-xs text-gray-400 dark:text-gray-500">|</span>
          <div class="flex items-center gap-4 text-xs text-gray-500 dark:text-gray-400">
            <span>Interval: <span id="batch-interval" class="font-medium text-gray-700 dark:text-gray-300">{{ replication_config.get_batch_interval_display|default:"--" }}</span></span>
            <span>Max: <span id="batch-max-duration" class="font-medium text-gray-700 dark:text-gray-300">{{ replication_config.batch_max_catchup_minutes }}m</span></span>
            <span>Last: <span id="batch-last-run" class="font-medium text-gray-700 dark:text-gray-300">{% if replication_config.last_batch_run %}{{ replication_config.last_batch_run|timesince }} ago{% else %}Never{% endif %}</span></span>
            <span>Next: <span id="batch-next-run" class="font-medium text-gray-700 dark:text-gray-300">{% if replication_config.next_batch_run %}{{ replication_config.next_batch_run|date:"M d, g:i A" }}{% else %}--{% endif %}</span></span>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}


  <!-- Table Rows Panel (collapsible, auto-loads) -->
  <div class="mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow" x-data="{ rowsOpen: true }">
      <div class="flex items-center justify-between px-6 py-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-t-lg transition" @click="rowsOpen = !rowsOpen">
        <div class="flex items-center gap-3">
          <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
          </svg>
          <span class="text-sm font-semibold text-gray-900 dark:text-white">Tables</span>
          <span id="table-rows-count" class="text-xs text-gray-500 dark:text-gray-400"></span>
        </div>
        <div class="flex items-center gap-2">
          <button id="btn-refresh-rows" @click.stop="fetchTableRows()" title="Refresh row counts"
            class="p-1.5 text-gray-400 hover:text-blue-600 dark:hover:text-blue-400 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded-lg transition">
            <svg id="refresh-rows-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
          </button>
          <svg class="w-4 h-4 text-gray-400 transition-transform" :class="rowsOpen ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </div>
      </div>
      <div x-show="rowsOpen" x-collapse>
        <div class="px-6 pb-4">
          <div id="table-rows-body">
            <div class="flex items-center justify-center py-6 gap-2 text-sm text-gray-400 dark:text-gray-500">
              <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
              Loading row counts...
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Active Tuning Settings -->
  <div class="mb-6 bg-white dark:bg-gray-800 rounded-lg shadow" x-data="{ tuneOpen: false }">
    <div class="flex items-center justify-between px-6 py-4 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 rounded-t-lg transition border-b border-gray-200 dark:border-gray-700"
         @click="tuneOpen = !tuneOpen">
      <div class="flex items-center gap-2">
        <svg class="w-4 h-4 text-orange-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
        </svg>
        <span class="text-sm font-semibold text-gray-900 dark:text-white">Active Tuning Settings</span>
      </div>
      <svg class="w-4 h-4 text-gray-400 transition-transform" :class="tuneOpen ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </div>
    <div x-show="tuneOpen" x-transition>
      <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-0 divide-x divide-y divide-gray-100 dark:divide-gray-700 text-sm">
        <div class="px-4 py-3">
          <p class="text-xs text-gray-500 dark:text-gray-400">Snapshot Fetch Size</p>
          <p class="font-semibold text-gray-900 dark:text-white">{{ replication_config.snapshot_fetch_size|default:"10000" }}</p>
        </div>
        <div class="px-4 py-3">
          <p class="text-xs text-gray-500 dark:text-gray-400">Max Queue Size</p>
          <p class="font-semibold text-gray-900 dark:text-white">{{ replication_config.max_queue_size }}</p>
        </div>
        <div class="px-4 py-3">
          <p class="text-xs text-gray-500 dark:text-gray-400">Max Batch Size</p>
          <p class="font-semibold text-gray-900 dark:text-white">{{ replication_config.max_batch_size }}</p>
        </div>
        <div class="px-4 py-3">
          <p class="text-xs text-gray-500 dark:text-gray-400">Poll Interval</p>
          <p class="font-semibold text-gray-900 dark:text-white">{{ replication_config.poll_interval_ms }} ms</p>
        </div>
        <div class="px-4 py-3">
          <p class="text-xs text-gray-500 dark:text-gray-400">Sink Batch Size</p>
          <p class="font-semibold text-gray-900 dark:text-white">{{ replication_config.sink_batch_size|default:"3000" }}</p>
        </div>
        <div class="px-4 py-3">
          <p class="text-xs text-gray-500 dark:text-gray-400">Sink Max Poll Records</p>
          <p class="font-semibold text-gray-900 dark:text-white">{{ replication_config.sink_max_poll_records|default:"5000" }}</p>
        </div>
        <div class="px-4 py-3">
          <p class="text-xs text-gray-500 dark:text-gray-400">Snapshot Mode</p>
          <p class="font-semibold text-gray-900 dark:text-white">{{ replication_config.snapshot_mode }}</p>
        </div>
        <div class="px-4 py-3">
          <p class="text-xs text-gray-500 dark:text-gray-400">Incremental Chunk</p>
          <p class="font-semibold text-gray-900 dark:text-white">{{ replication_config.incremental_snapshot_chunk_size }}</p>
        </div>
      </div>
      <div class="px-4 py-2 border-t border-gray-100 dark:border-gray-700">
        <a href="{% url 'connector_edit_tables' replication_config.pk %}" class="text-xs text-blue-600 dark:text-blue-400 hover:underline">Edit settings →</a>
      </div>
    </div>
  </div>

  <!-- Connector Information -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Connector Info</h3>
      </div>
      <div class="p-6 space-y-3 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Connector Name</span>
          <span class="font-mono text-gray-900 dark:text-white">{{ replication_config.connector_name }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Version</span>
          <span class="text-gray-900 dark:text-white">v{{ replication_config.connector_version }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Topic Prefix</span>
          <span class="font-mono text-gray-900 dark:text-white">{{ replication_config.kafka_topic_prefix }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Processing Mode</span>
          <span class="text-gray-900 dark:text-white">{{ replication_config.processing_mode|upper }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Snapshot Mode</span>
          <span class="text-gray-900 dark:text-white">{{ replication_config.snapshot_mode }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Last Sync</span>
          <span class="text-gray-900 dark:text-white">{{ replication_config.last_sync_at|date:"M d, Y g:i A"|default:"Never" }}</span>
        </div>
        {% if connector_history %}
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Deployed At</span>
          <span class="text-gray-900 dark:text-white" title="{{ connector_history.created_at|date:'Y-m-d H:i:s' }}">{{ connector_history.created_at|date:"M d, Y g:i A" }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Uptime</span>
          <span class="text-gray-900 dark:text-white">{{ connector_history.created_at|timesince }}</span>
        </div>
        {% endif %}
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Config Sync</span>
          <span id="info-config-sync" class="text-gray-400 dark:text-gray-500 italic text-xs">checking…</span>
        </div>
      </div>
    </div>

    <!-- Statistics -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow">
      <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Statistics</h3>
      </div>
      <div class="p-6 space-y-3 text-sm">
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Total Rows Synced</span>
          <span id="stat-rows" class="font-semibold text-gray-900 dark:text-white">{{ unified_status.statistics.total_rows_synced|default:"0" }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Tables Enabled</span>
          <span class="text-gray-900 dark:text-white">{{ unified_status.statistics.tables_enabled }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Sink Connector</span>
          <span class="font-mono text-gray-900 dark:text-white">{{ replication_config.sink_connector_name|default:"--" }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Database Type</span>
          <span class="text-gray-900 dark:text-white">{{ database.db_type|upper }}</span>
        </div>
        <div class="flex justify-between">
          <span class="text-gray-500 dark:text-gray-400">Host</span>
          <span class="font-mono text-gray-900 dark:text-white">{{ database.host }}:{{ database.port }}</span>
        </div>
      </div>
    </div>
  </div>


  <!-- Delete Modal -->
  {% include "client/connectors/_delete_modal.html" %}

</div>

<!-- AJAX Polling Script -->
<script>
// CSRF token for POST requests
const CSRF_TOKEN = '{{ csrf_token }}';

function connectorAction(url, loadingMsg) {
  showToast('info', loadingMsg);

  fetch(url, {
    method: 'POST',
    headers: { 'X-CSRFToken': CSRF_TOKEN, 'Content-Type': 'application/json' },
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showToast('success', data.message || 'Success');
    } else {
      showToast('error', data.message || data.error || 'Failed');
    }
    setTimeout(pollNow, 500);
  })
  .catch(err => {
    showToast('error', 'Request failed');
  });
}

// Table Rows - fetch source & target row counts
const TABLE_ROWS_URL = '{% url "connector_table_rows_api" replication_config.pk %}';

// TableMapping.last_sync_at / last_sync_status / total_rows_synced are legacy
// fields never written in the Kafka Connect pipeline — removed from table.
const LIVE_METRICS_URL = '{% url "connector_live_metrics_api" replication_config.pk %}';

// ── Live Metrics Polling ──────────────────────────────────────────────────────
function fmt(n) { return n !== undefined && n !== null ? Number(n).toLocaleString() : '--'; }

function fetchLiveMetrics() {
  document.getElementById('metrics-refresh-badge').classList.remove('hidden');
  fetch(LIVE_METRICS_URL)
    .then(r => r.json())
    .then(data => {
      document.getElementById('metrics-refresh-badge').classList.add('hidden');
      document.getElementById('metrics-last-updated').textContent = 'Updated ' + new Date().toLocaleTimeString();

      const unavailEl = document.getElementById('metrics-unavailable');

      // ── Streaming metrics ──
      const s = data.streaming || {};
      if (s.available) {
        unavailEl.classList.add('hidden');
        const lagMs = s.lag_ms || 0;
        const lagEl = document.getElementById('m-lag');
        lagEl.textContent = s.lag_display || '--';
        lagEl.className = 'text-xl font-bold mt-0.5 ' + (lagMs > 60000 ? 'text-red-600 dark:text-red-400' : lagMs > 5000 ? 'text-yellow-600 dark:text-yellow-400' : 'text-green-600 dark:text-green-400');

        const qpct = s.queue_pct || 0;
        const qEl = document.getElementById('m-queue-pct');
        qEl.textContent = qpct + '%';
        qEl.className = 'text-xl font-bold mt-0.5 ' + (qpct > 80 ? 'text-red-600 dark:text-red-400' : qpct > 50 ? 'text-yellow-600 dark:text-yellow-400' : 'text-gray-900 dark:text-white');
        document.getElementById('m-queue-bar').style.width = qpct + '%';
        document.getElementById('m-queue-bar').className = 'm-queue-bar h-1.5 rounded-full transition-all duration-500 ' + (qpct > 80 ? 'bg-red-500' : qpct > 50 ? 'bg-yellow-500' : 'bg-blue-500');

      } else {
        unavailEl.classList.remove('hidden');
        ['m-lag','m-queue-pct'].forEach(id => { const el = document.getElementById(id); if(el) el.textContent = '--'; });
      }

      // ── Config diff ──
      const cd = data.config_diff || {};
      const syncEl = document.getElementById('info-config-sync');
      const driftBanner = document.getElementById('config-drift-banner');
      const driftList = document.getElementById('config-drift-list');
      if (cd.available) {
        if (cd.in_sync) {
          if (syncEl) { syncEl.textContent = '✓ In sync'; syncEl.className = 'text-xs text-green-600 dark:text-green-400'; }
          driftBanner.classList.add('hidden');
        } else {
          if (syncEl) { syncEl.textContent = '⚠ Drift detected'; syncEl.className = 'text-xs text-yellow-600 dark:text-yellow-400 font-semibold'; }
          driftBanner.classList.remove('hidden');
          driftList.innerHTML = cd.diffs.map(d =>
            `<li>${d.key}: live=<b>${d.live}</b>, stored=<b>${d.stored}</b></li>`
          ).join('');
        }
      } else {
        if (syncEl) { syncEl.textContent = 'unavailable'; syncEl.className = 'text-xs text-gray-400 dark:text-gray-500 italic'; }
      }
    })
    .catch(() => {
      document.getElementById('metrics-refresh-badge').classList.add('hidden');
    });
}

// Initial fetch + poll every 10s
fetchLiveMetrics();
setInterval(fetchLiveMetrics, 10000);

function fetchTableRows() {
  const body = document.getElementById('table-rows-body');
  const countEl = document.getElementById('table-rows-count');
  const refreshIcon = document.getElementById('refresh-rows-icon');

  // Show spinner on refresh icon
  if (refreshIcon) refreshIcon.classList.add('animate-spin');

  // Show loading state
  body.innerHTML = '<div class="flex items-center justify-center py-6 gap-2 text-sm text-gray-400 dark:text-gray-500">'
    + '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>'
    + 'Loading row counts...</div>';

  fetch(TABLE_ROWS_URL)
    .then(r => r.json())
    .then(data => {
      if (refreshIcon) refreshIcon.classList.remove('animate-spin');
      if (!data.success) {
        body.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Failed to load row counts</p>';
        return;
      }

      const tables = data.tables;
      if (countEl) countEl.textContent = tables.length + ' table' + (tables.length !== 1 ? 's' : '');

      if (tables.length === 0) {
        body.innerHTML = '<p class="text-sm text-gray-400 dark:text-gray-500 text-center py-4">No enabled tables</p>';
        return;
      }

      // Render error labels for row count failures
      function fmtCell(count, error) {
        if (count !== null) return '<span class="font-semibold text-gray-900 dark:text-white">' + Number(count).toLocaleString() + '</span>';
        if (error === 'db_unreachable') return '<span class="text-red-500 text-xs" title="Database is unreachable">DB offline</span>';
        if (error === 'table_not_found') return '<span class="text-yellow-500 text-xs" title="Table does not exist">Not found</span>';
        if (error === 'no_target_db') return '<span class="text-gray-400 text-xs" title="No target database configured">No target DB</span>';
        if (error === 'error') return '<span class="text-red-400 text-xs" title="Query failed">Error</span>';
        return '<span class="text-gray-400">--</span>';
      }

      // Show database connectivity warnings
      let warnings = '';
      if (!data.source_reachable) {
        warnings += '<div class="flex items-center gap-2 px-3 py-2 mb-3 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 text-xs">'
          + '<svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>'
          + 'Source database is unreachable</div>';
      }
      if (data.has_target_db && !data.target_reachable) {
        warnings += '<div class="flex items-center gap-2 px-3 py-2 mb-3 rounded-lg bg-red-50 dark:bg-red-900/20 text-red-700 dark:text-red-400 text-xs">'
          + '<svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path></svg>'
          + 'Target database is unreachable</div>';
      }
      if (!data.has_target_db) {
        warnings += '<div class="flex items-center gap-2 px-3 py-2 mb-3 rounded-lg bg-yellow-50 dark:bg-yellow-900/20 text-yellow-700 dark:text-yellow-400 text-xs">'
          + '<svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
          + 'No target database configured for this client</div>';
      }

      let html = warnings + '<table class="w-full text-sm">'
        + '<thead><tr class="text-xs text-gray-500 dark:text-gray-400 uppercase border-b border-gray-200 dark:border-gray-700">'
        + '<th class="py-2 pr-2 text-left w-8">#</th>'
        + '<th class="py-2 pr-2 text-left">Source Table</th>'
        + '<th class="py-2 pr-2 text-left">Target Table</th>'
        + '<th class="py-2 pl-2 text-right">Source Rows</th>'
        + '<th class="py-2 pl-2 text-right">Target Rows</th>'
        + '</tr></thead><tbody>';

      tables.forEach((t, i) => {
        html += '<tr style="border-bottom:1px solid rgba(107,114,128,0.2)" onmouseover="this.style.background=\'rgba(107,114,128,0.15)\'" onmouseout="this.style.background=\'\'">'
          + '<td class="py-2 pr-2 text-gray-400 dark:text-gray-500">' + (i + 1) + '</td>'
          + '<td class="py-2 pr-2 font-mono text-gray-900 dark:text-white truncate max-w-[200px]" title="' + t.source_table + '">' + t.source_table + '</td>'
          + '<td class="py-2 pr-2 font-mono text-gray-600 dark:text-gray-400 truncate max-w-[200px]" title="' + t.target_table + '">' + t.target_table + '</td>'
          + '<td class="py-2 pl-2 text-right">' + fmtCell(t.source_rows, t.source_error) + '</td>'
          + '<td class="py-2 pl-2 text-right">' + fmtCell(t.target_rows, t.target_error) + '</td>'
          + '</tr>';
      });

      html += '</tbody></table>';
      body.innerHTML = html;
    })
    .catch(err => {
      if (refreshIcon) refreshIcon.classList.remove('animate-spin');
      body.innerHTML = '<p class="text-sm text-red-500 text-center py-4">Failed to load row counts</p>';
      console.warn('Table rows fetch failed:', err);
    });
}

// Auto-load row counts on page load
fetchTableRows();

(function() {
  const STATUS_URL = '{% url "connector_status_api" replication_config.pk %}';
  const POLL_INTERVAL = 5000;
  const IDLE_INTERVAL = 30000;
  let currentInterval = POLL_INTERVAL;
  let timer = null;

  // Batch schedule state
  let batchNextRun = null;   // Date object
  let batchLastRun = null;   // Date object
  let batchSyncing = false;  // true when source connector is RUNNING in batch mode
  let batchSyncStart = null; // Date when sync started
  let countdownTimer = null;
  const isBatch = '{{ replication_config.processing_mode }}' === 'batch';

  function formatNumber(n) {
    return Number(n || 0).toLocaleString();
  }

  function stateColor(state) {
    if (state === 'RUNNING') return 'text-green-600 dark:text-green-400';
    if (state === 'PAUSED') return 'text-yellow-600 dark:text-yellow-400';
    return 'text-red-600 dark:text-red-400';
  }

  function healthColor(h) {
    if (h === 'healthy') return 'text-green-600 dark:text-green-400';
    return 'text-red-600 dark:text-red-400';
  }

  function formatDuration(totalSeconds) {
    if (totalSeconds <= 0) return '00:00';
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    const pad = v => String(v).padStart(2, '0');
    return h > 0 ? pad(h) + ':' + pad(m) + ':' + pad(s) : pad(m) + ':' + pad(s);
  }

  function timeAgo(date) {
    if (!date) return 'Never';
    const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
    if (seconds < 60) return seconds + 's ago';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return minutes + 'm ago';
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + 'h ' + (minutes % 60) + 'm ago';
    const days = Math.floor(hours / 24);
    return days + 'd ago';
  }

  function updateBatchCountdown() {
    const label = document.getElementById('batch-countdown-label');
    const display = document.getElementById('batch-countdown');
    const badge = document.getElementById('batch-status-badge');
    if (!label || !display) return;

    if (batchSyncing) {
      // Show elapsed sync time
      label.textContent = 'Syncing...';
      const elapsed = Math.floor((Date.now() - (batchSyncStart || Date.now())) / 1000);
      display.textContent = formatDuration(elapsed);
      display.className = 'text-3xl font-bold text-green-600 dark:text-green-400 font-mono';
      badge.textContent = 'Syncing';
      badge.className = 'ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400';
    } else if (batchNextRun) {
      // Show countdown to next run
      const remaining = Math.max(0, Math.floor((batchNextRun.getTime() - Date.now()) / 1000));
      label.textContent = 'Next sync in';
      display.textContent = formatDuration(remaining);
      display.className = 'text-3xl font-bold text-purple-600 dark:text-purple-400 font-mono';
      badge.textContent = 'Scheduled';
      badge.className = 'ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400';

      if (remaining <= 0) {
        display.textContent = '00:00';
        label.textContent = 'Starting soon...';
      }
    } else {
      label.textContent = 'Next sync';
      display.textContent = '--:--';
      display.className = 'text-3xl font-bold text-gray-400 dark:text-gray-500 font-mono';
      badge.textContent = 'No schedule';
      badge.className = 'ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-400';
    }

    // Update last synced (keeps ticking)
    const lastRunEl = document.getElementById('batch-last-run');
    if (lastRunEl) lastRunEl.textContent = timeAgo(batchLastRun);
  }

  function updateBatchSchedule(s) {
    const batch = s.batch_schedule;
    if (!batch) return;

    // Determine if currently syncing (source connector RUNNING in batch mode = active sync)
    const sourceState = s.source_connector.state;
    const wasSyncing = batchSyncing;
    batchSyncing = sourceState === 'RUNNING';

    if (batchSyncing && !wasSyncing) {
      batchSyncStart = new Date();
    } else if (!batchSyncing) {
      batchSyncStart = null;
    }

    // Update schedule timestamps
    batchNextRun = batch.next_batch_run ? new Date(batch.next_batch_run) : null;
    batchLastRun = batch.last_batch_run ? new Date(batch.last_batch_run) : null;

    // Update static fields
    const intervalEl = document.getElementById('batch-interval');
    if (intervalEl) intervalEl.textContent = batch.batch_interval_display || '--';

    const maxEl = document.getElementById('batch-max-duration');
    if (maxEl) maxEl.textContent = batch.batch_max_catchup_minutes + ' min';

    const nextRunEl = document.getElementById('batch-next-run');
    if (nextRunEl && batchNextRun) {
      nextRunEl.textContent = batchNextRun.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ', ' +
        batchNextRun.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
    }

    // Update schedule status badge
    const badge = document.getElementById('batch-status-badge');
    if (badge) {
      if (batchSyncing) {
        badge.textContent = 'Syncing';
        badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400';
      } else if (batch.is_on_schedule) {
        badge.textContent = 'Scheduled';
        badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 dark:bg-purple-900/30 dark:text-purple-400';
      } else {
        badge.textContent = 'Off Schedule';
        badge.className = 'inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400';
      }
    }

    updateBatchCountdown();
  }

  function taskBgClass(state) {
    if (state === 'RUNNING') return 'bg-green-50 dark:bg-green-900/10';
    if (state === 'PAUSED') return 'bg-yellow-50 dark:bg-yellow-900/10';
    return 'bg-red-50 dark:bg-red-900/10';
  }

  function taskTextClass(state) {
    if (state === 'RUNNING') return 'text-green-700 dark:text-green-400';
    if (state === 'PAUSED') return 'text-yellow-700 dark:text-yellow-400';
    return 'text-red-700 dark:text-red-400';
  }

  function renderTasks(containerId, tasks) {
    const container = document.getElementById(containerId);
    if (!container) return;

    if (!tasks || tasks.length === 0) {
      container.innerHTML = '<p class="text-xs text-gray-400 dark:text-gray-500 italic">No tasks</p>';
      return;
    }

    container.innerHTML = tasks.map(t => {
      const state = t.state || 'UNKNOWN';
      let traceHtml = '';
      if (state === 'FAILED' && t.trace) {
        const shortTrace = t.trace.substring(0, 120)
          .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        const fullTrace = t.trace.replace(/'/g, "\\'").replace(/\n/g, '\\n');
        traceHtml = `<button class="w-full text-left mt-0.5 px-2 py-1.5 bg-red-50 dark:bg-red-900/10 rounded group" onclick="showErrorModal('Task ${t.id} \u2014 Error Trace', '${fullTrace}')">
          <p class="text-xs font-mono text-red-600 dark:text-red-400 truncate">${shortTrace}</p>
          <p class="text-xs text-red-400 dark:text-red-500 mt-0.5 group-hover:underline">Click to view full trace &rarr;</p>
        </button>`;
      }
      return `<div>
        <div class="flex items-center justify-between text-xs px-2 py-1 rounded ${taskBgClass(state)}">
          <span class="text-gray-600 dark:text-gray-400">Task ${t.id}</span>
          <span class="font-medium ${taskTextClass(state)}">${state}</span>
        </div>${traceHtml}
      </div>`;
    }).join('');
  }

  function updateStatus(data) {
    const s = data.status;

    // Source connector state + tasks
    const srcEl = document.getElementById('source-state');
    srcEl.textContent = s.source_connector.state;
    srcEl.className = 'text-sm font-bold ' + stateColor(s.source_connector.state);
    renderTasks('source-tasks', s.source_connector.tasks);

    // Sink connector state + tasks
    const sinkEl = document.getElementById('sink-state');
    sinkEl.textContent = s.sink_connector.state;
    sinkEl.className = 'text-sm font-bold ' + stateColor(s.sink_connector.state);
    renderTasks('sink-tasks', s.sink_connector.tasks);

    // Task health bar
    const allTasks = [...(s.source_connector.tasks || []), ...(s.sink_connector.tasks || [])];
    const hasFailed = allTasks.some(t => t.state === 'FAILED');
    const allRunning = allTasks.length > 0 && allTasks.every(t => t.state === 'RUNNING');
    const allPaused = allTasks.length > 0 && allTasks.every(t => t.state === 'PAUSED');

    const healthEl = document.getElementById('task-health-status');
    if (healthEl) {
      if (hasFailed) {
        healthEl.textContent = 'Failed';
        healthEl.className = 'font-bold text-red-600 dark:text-red-400';
      } else if (allPaused) {
        healthEl.textContent = 'All Paused';
        healthEl.className = 'font-bold text-yellow-600 dark:text-yellow-400';
      } else if (allRunning) {
        healthEl.textContent = 'All Running';
        healthEl.className = 'font-bold text-green-600 dark:text-green-400';
      } else {
        healthEl.textContent = s.overall.charAt(0).toUpperCase() + s.overall.slice(1);
        healthEl.className = 'font-bold ' + healthColor(s.overall);
      }
    }

    // Statistics
    document.getElementById('stat-rows').textContent = formatNumber(s.statistics.total_rows_synced);

    // Update action button visibility
    updateActionButtons(s);

    // Batch schedule update
    if (isBatch && s.batch_schedule) {
      updateBatchSchedule(s);
    }

    // Snapshot panel
    const panel = document.getElementById('snapshot-panel');
    const snap = s.snapshot;

    if (snap && (snap.running || snap.completed)) {
      panel.classList.remove('hidden');

      const typeLabel = snap.type === 'initial' ? 'Initial Snapshot' : 'Incremental Snapshot';
      document.getElementById('snapshot-title').textContent = typeLabel;

      const badge = document.getElementById('snapshot-badge');
      if (snap.running) {
        badge.textContent = 'Running';
        badge.className = 'ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400';
        document.getElementById('snapshot-spinner').classList.remove('hidden');
      } else if (snap.completed) {
        badge.textContent = 'Complete';
        badge.className = 'ml-auto inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400';
        document.getElementById('snapshot-spinner').classList.add('hidden');
      }

      const done = snap.completed_tables || 0;
      const total = snap.total_tables || 0;
      const pct = total > 0 ? Math.round((done / total) * 100) : 0;

      document.getElementById('snap-done').textContent = done;
      document.getElementById('snap-total').textContent = total;
      document.getElementById('snap-pct').textContent = pct + '%';
      document.getElementById('snap-bar').style.width = pct + '%';

      document.getElementById('snap-rows').textContent = formatNumber(snap.total_rows_scanned);
      document.getElementById('snap-duration').textContent = (snap.duration_seconds || 0) + 's';
      document.getElementById('snap-current').textContent = snap.current_table || '--';
      document.getElementById('snap-current').title = snap.current_table || '';
      document.getElementById('snap-remain-val').textContent = snap.remaining_tables || 0;

      currentInterval = snap.running ? POLL_INTERVAL : IDLE_INTERVAL;
    } else {
      if (!snap || (!snap.running && !snap.completed)) {
        panel.classList.add('hidden');
      }
      currentInterval = batchSyncing ? POLL_INTERVAL : IDLE_INTERVAL;
    }
  }

  function toggleBtn(id, show) {
    const el = document.getElementById(id);
    if (!el) return;
    if (show) el.classList.remove('hidden');
    else el.classList.add('hidden');
  }

  function updateActionButtons(s) {
    const sourceState = s.source_connector.state;
    const sourceTasks = s.source_connector.tasks || [];
    const sinkTasks = s.sink_connector.tasks || [];

    // Source: Pause when RUNNING, Resume when PAUSED
    toggleBtn('btn-src-pause', sourceState === 'RUNNING');
    toggleBtn('btn-src-resume', sourceState === 'PAUSED');

    // Source: Restart Failed visible when any source task FAILED
    toggleBtn('btn-src-restart-failed', sourceTasks.some(t => t.state === 'FAILED'));

    // Sink: Restart Failed visible when any sink task FAILED
    toggleBtn('btn-sink-restart-failed', sinkTasks.some(t => t.state === 'FAILED'));

    // Sync with Schedule: hide when on schedule and paused
    const btnSyncSchedule = document.getElementById('btn-sync-schedule');
    if (btnSyncSchedule && s.batch_schedule) {
      if (s.batch_schedule.is_on_schedule && sourceState === 'PAUSED') {
        btnSyncSchedule.classList.add('hidden');
      } else {
        btnSyncSchedule.classList.remove('hidden');
      }
    }
  }

  // Expose pollNow for action buttons to trigger immediate refresh
  window.pollNow = function() {
    if (timer) clearTimeout(timer);
    poll();
  };

  function poll() {
    fetch(STATUS_URL)
      .then(r => r.json())
      .then(data => {
        if (data.success) updateStatus(data);
      })
      .catch(err => console.warn('Status poll failed:', err))
      .finally(() => {
        timer = setTimeout(poll, currentInterval);
      });
  }

  // Start polling
  timer = setTimeout(poll, POLL_INTERVAL);

  // Start 1-second countdown ticker for batch mode
  if (isBatch) {
    countdownTimer = setInterval(updateBatchCountdown, 1000);
  }
})();
</script>

<!-- Error Trace Modal -->
<div id="error-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4" onclick="closeErrorModal()">
    <div class="relative bg-white dark:bg-gray-900 rounded-xl shadow-2xl flex flex-col" style="width:100%;max-width:48rem;max-height:72vh;" onclick="event.stopPropagation()">
      <div class="flex items-start justify-between px-5 py-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
        <div class="min-w-0 flex-1 pr-4">
          <p class="text-xs font-semibold text-red-500 uppercase tracking-wide mb-0.5">Error Details</p>
          <h3 id="error-modal-title" class="text-sm font-semibold text-gray-900 dark:text-white font-mono break-all"></h3>
        </div>
        <button onclick="closeErrorModal()"
                class="flex-shrink-0 p-1 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <div class="overflow-y-auto flex-1 p-5">
        <pre id="error-modal-body" class="text-xs text-red-700 dark:text-red-300 font-mono whitespace-pre-wrap break-words leading-relaxed select-text cursor-text"></pre>
      </div>
      <div class="flex justify-between px-5 py-3 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
        <button id="error-modal-copy-btn" onclick="copyErrorModal()"
                class="px-4 py-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
          </svg>
          Copy
        </button>
        <button onclick="closeErrorModal()"
                class="px-4 py-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
<script>
function showErrorModal(title, trace) {
  document.getElementById('error-modal-title').textContent = title;
  document.getElementById('error-modal-body').textContent = trace;
  document.getElementById('error-modal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}
function closeErrorModal() {
  document.getElementById('error-modal').classList.add('hidden');
  document.body.style.overflow = '';
}
function copyErrorModal() {
  const text = document.getElementById('error-modal-body').textContent;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.getElementById('error-modal-copy-btn');
    btn.textContent = 'Copied!';
    setTimeout(() => {
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg> Copy';
    }, 2000);
  });
}
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeErrorModal();
});
</script>
{% endblock %}