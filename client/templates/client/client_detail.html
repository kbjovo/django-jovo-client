{% extends "index.html" %}

{% block content %}
<style>
  /* Custom scrollbar for tab content */
  #client-detail-section .overflow-y-auto::-webkit-scrollbar {
    width: 8px;
  }

  #client-detail-section .overflow-y-auto::-webkit-scrollbar-track {
    background: transparent;
  }

  #client-detail-section .overflow-y-auto::-webkit-scrollbar-thumb {
    background: #9ca3af;
    border-radius: 4px;
  }

  #client-detail-section .overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
  }

  /* Dark mode scrollbar */
  .dark #client-detail-section .overflow-y-auto::-webkit-scrollbar-thumb {
    background: #4b5563;
  }

  .dark #client-detail-section .overflow-y-auto::-webkit-scrollbar-thumb:hover {
    background: #6b7280;
  }

  /* Firefox scrollbar */
  #client-detail-section .overflow-y-auto {
    scrollbar-width: thin;
    scrollbar-color: #9ca3af transparent;
  }

  .dark #client-detail-section .overflow-y-auto {
    scrollbar-color: #4b5563 transparent;
  }
</style>
<div id="client-detail-section" class="max-w-7xl mx-auto py-3 px-3 h-[calc(100vh-50px)] flex flex-col overflow-hidden"
     x-data="{
       activeTab: new URLSearchParams(window.location.search).get('tab') || 'basic',
       editMode: false,
       showDatabaseModal: false,
       showTestResultModal: false,
       testResult: {},
       deletingDatabase: null,
       deletingDbName: '',
       deletingDbConnectors: 0,
       deleteDbConfirmed: false,
       deleteDbTopics: false,
       deleteDbTables: false,
       editingDatabase: null,
       isDeletingConnection: false,
       isSavingConnection: false,

       // Add the saveDatabase function here
       async saveDatabase() {
         this.isSavingConnection = true;
         const formDataToSend = new FormData();

         for (const key in this.testResult.formData) {
           formDataToSend.append(key, this.testResult.formData[key]);
         }

         const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

         try {
           const response = await fetch(this.testResult.url, {
             method: 'POST',
             body: formDataToSend,
             headers: {
               'X-CSRFToken': csrfToken,
               'HX-Request': 'true'
             }
           });

           if (response.ok) {
             const html = await response.text();
             document.getElementById('databases-content').innerHTML = html;
             this.showTestResultModal = false;
             this.showDatabaseModal = false;

             if (window.htmx) {
               htmx.process(document.getElementById('databases-content'));
             }

             // Show success toast
             if (window.showToast) {
               window.showToast('success', 'Database connection created successfully!');
             }
           } else {
             if (window.showToast) {
               window.showToast('error', 'Failed to save database connection');
             }
           }
         } catch (error) {
           console.error('Error saving database:', error);
           if (window.showToast) {
             window.showToast('error', 'Error saving database: ' + error.message);
           }
         } finally {
           this.isSavingConnection = false;
         }
       },

       async deleteConnection() {
         this.isDeletingConnection = true;
         const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

         const formData = new FormData();
         if (this.deleteDbTopics) {
           formData.append('delete_topics', '1');
         }
         if (this.deleteDbTables) {
           formData.append('drop_tables', '1');
         }

         try {
           const response = await fetch(`/clients/databases/${this.deletingDatabase}/delete/`, {
             method: 'POST',
             body: formData,
             headers: {
               'X-CSRFToken': csrfToken,
               'HX-Request': 'true'
             }
           });

           if (response.ok) {
             const html = await response.text();
             document.getElementById('databases-content').innerHTML = html;
             this.deletingDatabase = null;
             this.deleteDbConfirmed = false;
             this.deleteDbTopics = false;
             this.deleteDbTables = false;

             if (window.htmx) {
               htmx.process(document.getElementById('databases-content'));
             }

             if (window.showToast) {
               window.showToast('success', 'Database connection and connectors deleted successfully!');
             }
           } else {
             if (window.showToast) {
               window.showToast('error', 'Failed to delete database connection');
             }
           }
         } catch (error) {
           console.error('Error deleting database:', error);
           if (window.showToast) {
             window.showToast('error', 'Error deleting database: ' + error.message);
           }
         } finally {
           this.isDeletingConnection = false;
         }
       }
     }"
     @close-modal.window="showDatabaseModal = false"
     @show-test-result.window="testResult = $event.detail; showTestResultModal = true; if (!$event.detail.isUpdateMode) { showDatabaseModal = false; }"
     @clientUpdated.window="editMode = false">
  
  <!-- Breadcrumbs -->
  <nav class="flex mb-4 flex-shrink-0" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
      <li class="inline-flex items-center">
        <a href="{% url 'main-dashboard' %}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600 dark:text-gray-400 dark:hover:text-white">
          <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path>
          </svg>
          Dashboard
        </a>
      </li>
      <li>
        <div class="flex items-center">
          <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
          <a href="{% url 'main-dashboard' %}" class="ml-1 text-sm font-medium text-gray-700 hover:text-blue-600 md:ml-2 dark:text-gray-400 dark:hover:text-white">Clients</a>
        </div>
      </li>
      <li aria-current="page">
        <div class="flex items-center">
          <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
          </svg>
          <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2 dark:text-gray-400">{{ client.name }}</span>
        </div>
      </li>
    </ol>
  </nav>

  <div class="bg-white dark:bg-gray-900 shadow-md rounded-2xl border border-gray-100 dark:border-gray-700 flex flex-col flex-1 overflow-hidden">

    <!-- Header with Client Name, Status Badge, and Delete Button -->
    <div class="px-8 py-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-xl font-medium text-gray-900 dark:text-white">
            {{ client.name }}
            <span class="ml-3 inline-flex items-center px-3 py-1 text-xs font-semibold rounded-full
              {% if client.status == 'active' %}
                bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400
              {% elif client.status == 'inactive' %}
                bg-yellow-100 text-yellow-800 dark:bg-yellow-900/30 dark:text-yellow-400
              {% else %}
                bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400
              {% endif %}">
              {{ client.status|capfirst }}
            </span>
          </h2>
          <div class="mt-1 flex items-center gap-4 text-sm text-gray-500 dark:text-gray-400">
            <span>Created: {{ client.created_at|date:"jS M Y, g:i A" }}</span>
            <span>â€¢</span>
            <span>Updated: {{ client.updated_at|date:"jS M Y, g:i A" }}</span>
          </div>
        </div>

        <!-- Delete Button -->
        <div x-data="{ showDeleteModal: false }">
          {% if client.status != 'deleted' %}
          <button 
            @click="showDeleteModal = true"
            class="inline-flex text-sm items-center gap-2 bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-3 rounded-lg shadow transition">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
            Delete
          </button>

          <!-- Delete Client Modal -->
          <div 
            x-show="showDeleteModal"
            x-cloak
            @keydown.escape.window="showDeleteModal = false"
            class="fixed inset-0 z-50 overflow-y-auto"
            role="dialog" 
            aria-modal="true">
            
            <div 
              x-show="showDeleteModal"
              x-transition:enter="ease-out duration-300"
              x-transition:enter-start="opacity-0"
              x-transition:enter-end="opacity-100"
              x-transition:leave="ease-in duration-200"
              x-transition:leave-start="opacity-100"
              x-transition:leave-end="opacity-0"
              class="fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 transition-opacity"
              @click="showDeleteModal = false">
            </div>

            <div class="flex min-h-full items-center justify-center p-4">
              <div 
                x-show="showDeleteModal"
                x-transition:enter="ease-out duration-300"
                x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave="ease-in duration-200"
                x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                
                <div class="bg-white dark:bg-gray-800 px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                  <div class="sm:flex sm:items-start">
                    <div class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/30 sm:mx-0 sm:h-10 sm:w-10">
                      <svg class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                      </svg>
                    </div>
                    
                    <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                      <h3 class="text-lg font-semibold leading-6 text-gray-900 dark:text-white">
                        Delete Client
                      </h3>
                      <div class="mt-2">
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                          Are you sure you want to delete <strong class="text-gray-900 dark:text-white">{{ client.name }}</strong>? 
                          This action cannot be undone.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-900 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-3">
                  <form method="post" action="{% url 'client_soft_delete' client.pk %}">
                    {% csrf_token %}
                    <button 
                      type="submit"
                      class="inline-flex w-full justify-center rounded-lg bg-red-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-700 sm:w-auto transition">
                      Delete
                    </button>
                  </form>
                  <button 
                    type="button"
                    @click="showDeleteModal = false"
                    class="mt-3 inline-flex w-full justify-center rounded-lg bg-white dark:bg-gray-800 px-4 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 sm:mt-0 sm:w-auto transition">
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
      <nav class="flex px-8 -mb-px space-x-8" aria-label="Tabs">
        <button
          @click="activeTab = 'basic'; editMode = false; history.replaceState(null, '', '?tab=basic')"
          :class="activeTab === 'basic' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
          class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition">
          Basic Details
        </button>

        <button
          @click="activeTab = 'databases'; history.replaceState(null, '', '?tab=databases')"
          :class="activeTab === 'databases' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
          class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition">
          Databases
        </button>

        <button
          @click="activeTab = 'connectors'; history.replaceState(null, '', '?tab=connectors')"
          :class="activeTab === 'connectors' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
          class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition">
          Connectors
        </button>

        <button
          @click="activeTab = 'apis'; history.replaceState(null, '', '?tab=apis')"
          :class="activeTab === 'apis' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
          class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition">
          APIs
        </button>

        <button
          @click="activeTab = 'thirdparty'; history.replaceState(null, '', '?tab=thirdparty')"
          :class="activeTab === 'thirdparty' ? 'border-blue-600 text-blue-600 dark:border-blue-400 dark:text-blue-400' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 dark:text-gray-400 dark:hover:text-gray-300'"
          class="whitespace-nowrap py-2 px-1 border-b-2 font-medium text-sm transition">
          Third Party Sources
        </button>
      </nav>
    </div>

    <!-- Tab Content -->
    <div class="flex-1 overflow-y-auto">
      <div class="p-8">
        
        <!-- Basic Details Tab -->
        <div x-show="activeTab === 'basic'" x-transition>
          <div id="basic-details-content">
            <div x-show="!editMode" x-transition>
              {% include 'client/partials/basic_details_view.html' %}
            </div>
            <div x-show="editMode" x-transition>
              {% include 'client/partials/basic_details_edit.html' %}
            </div>
          </div>
        </div>

        <!-- Databases Tab -->
        <div x-show="activeTab === 'databases'" x-transition>
          <div id="databases-content">
            {% include 'client/partials/databases_list.html' %}
          </div>
        </div>

        <!-- Connectors Tab -->
        <div x-show="activeTab === 'connectors'" x-transition>
          <div id="connectors-content">
            {% include 'client/partials/connectors_list.html' %}
          </div>
        </div>

        <!-- APIs Tab -->
        <div x-show="activeTab === 'apis'" x-transition>
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No APIs configured</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">API integrations will appear here.</p>
          </div>
        </div>

        <!-- Third Party Sources Tab -->
        <div x-show="activeTab === 'thirdparty'" x-transition>
          <div class="text-center py-12">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path>
            </svg>
            <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-white">No third party sources</h3>
            <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">External integrations will appear here.</p>
          </div>
        </div>

      </div>
    </div>
  </div>


  <!-- Database Form Modal -->
  <div 
    x-show="showDatabaseModal"
    x-cloak
    @keydown.escape.window="showDatabaseModal = false"
    class="fixed inset-0 z-50 overflow-y-auto"
    role="dialog" 
    aria-modal="true">
    
    <div 
      x-show="showDatabaseModal"
      x-transition:enter="ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 transition-opacity"
      @click="showDatabaseModal = false">
    </div>

    <div class="flex min-h-full items-center justify-center p-4">
      <div 
        x-show="showDatabaseModal"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl"
        @click.stop>
        
        <div class="bg-white dark:bg-gray-800 px-6 py-5 relative" style="min-height: 400px;">
          <!-- Modal Loading Spinner -->
          <div
            id="modal-loading"
            class="htmx-indicator absolute inset-0 bg-white/80 dark:bg-gray-800/80 flex items-center justify-center z-10 rounded-lg">
            <div class="flex flex-col items-center gap-3">
              <svg class="animate-spin h-10 w-10 text-blue-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <p class="text-sm text-gray-900 dark:text-white font-medium">Loading form...</p>
            </div>
          </div>

          <div id="database-modal-form">
            <!-- For NEW: Include form directly -->
            <template x-if="editingDatabase === null">
              <div>
                {% include 'client/partials/database_form.html' with is_update=False form=form client=client %}
              </div>
            </template>
            <!-- For EDIT: Form will be loaded here via HTMX -->
            <div x-show="editingDatabase !== null" id="htmx-loaded-form"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Result Modal -->
  <div 
    x-show="showTestResultModal"
    x-cloak
    @keydown.escape.window="showTestResultModal = false"
    class="fixed inset-0 z-50 overflow-y-auto"
    role="dialog" 
    aria-modal="true">
    
    <div 
      x-show="showTestResultModal"
      x-transition:enter="ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-gray-500 bg-opacity-75 dark:bg-gray-900 dark:bg-opacity-80 transition-opacity"
      @click="showTestResultModal = false">
    </div>

    <div class="flex min-h-full items-center justify-center p-4">
      <div 
        x-show="showTestResultModal"
        x-transition:enter="ease-out duration-300"
        x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave="ease-in duration-200"
        x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
        x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
        class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg"
        @click.stop>
        
        <div class="bg-white dark:bg-gray-800 px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
          <div class="sm:flex sm:items-start">
            <!-- Icon -->
            <div 
              :class="testResult.success ? 'bg-green-100 dark:bg-green-900/30' : 'bg-red-100 dark:bg-red-900/30'"
              class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full sm:mx-0 sm:h-10 sm:w-10">
              <svg x-show="testResult.success" class="h-6 w-6 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <svg x-show="!testResult.success" class="h-6 w-6 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
              </svg>
            </div>
            
            <!-- Content -->
            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left flex-1">
              <h3 class="text-lg font-semibold leading-6 text-gray-900 dark:text-white">
                Connection Test <span x-text="testResult.success ? 'Successful' : 'Failed'"></span>
              </h3>
              <div class="mt-2">
                <p class="text-sm text-gray-500 dark:text-gray-400" x-text="testResult.message"></p>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="bg-gray-50 dark:bg-gray-900 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 gap-3">
          <!-- For ADD mode: Show Save button after test -->
          <template x-if="!testResult.isUpdateMode">
            <button
              @click="saveDatabase()"
              :disabled="isSavingConnection"
              :class="testResult.success ? 'bg-green-600 hover:bg-green-700' : 'bg-blue-600 hover:bg-blue-700'"
              class="inline-flex w-full justify-center items-center gap-2 rounded-lg px-4 py-2 text-sm font-semibold text-white shadow-sm sm:w-auto transition disabled:opacity-50 disabled:cursor-not-allowed">
              <svg x-show="isSavingConnection" class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <span x-text="isSavingConnection ? 'Saving...' : (testResult.success ? 'Save Connection' : 'Save Anyway')"></span>
            </button>
          </template>

          <!-- Cancel button -->
          <button
            type="button"
            @click="showTestResultModal = false; if (!testResult.isUpdateMode) { showDatabaseModal = true; }"
            :disabled="isSavingConnection"
            class="mt-3 inline-flex w-full justify-center rounded-lg bg-white dark:bg-gray-800 px-4 py-2 text-sm font-semibold text-gray-900 dark:text-gray-200 shadow-sm ring-1 ring-inset ring-gray-300 dark:ring-gray-600 hover:bg-gray-50 dark:hover:bg-gray-700 sm:mt-0 sm:w-auto transition disabled:opacity-50 disabled:cursor-not-allowed">
            Cancel
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Database Modal -->
  <div x-show="deletingDatabase !== null" x-cloak
       @keydown.escape.window="if (!isDeletingConnection) { deletingDatabase = null; deleteDbConfirmed = false; deleteDbTopics = false; deleteDbTables = false; }"
       class="fixed inset-0 z-50 flex items-center justify-center p-4"
       role="dialog" aria-modal="true">

    <!-- Backdrop -->
    <div x-show="deletingDatabase !== null" x-transition.opacity
         class="fixed inset-0 bg-black/50"
         @click="if (!isDeletingConnection) { deletingDatabase = null; deleteDbConfirmed = false; deleteDbTopics = false; deleteDbTables = false; }"></div>

    <!-- Modal -->
    <div x-show="deletingDatabase !== null" x-transition @click.stop
         class="relative w-full max-w-xs bg-white dark:bg-gray-800 rounded-xl shadow-2xl overflow-hidden">

      <!-- Header -->
      <div class="bg-red-600 px-5 py-3 flex items-center justify-between">
        <div>
          <h3 class="text-sm font-semibold text-white">Delete Database Connection</h3>
          <p class="text-red-100 text-xs" x-text="deletingDbName"></p>
        </div>
        <span x-show="deletingDbConnectors > 0" class="text-xs text-red-100" x-text="deletingDbConnectors + ' connector(s)'"></span>
      </div>

      <div class="px-5 py-4 space-y-3 text-xs">

        <!-- Warning when connectors exist -->
        <template x-if="deletingDbConnectors > 0">
          <div class="space-y-3">
            <!-- Always happens -->
            <div class="space-y-1.5">
              <p class="font-medium text-gray-400 dark:text-gray-500 uppercase tracking-wider">Always</p>
              <label class="flex items-center gap-2 text-gray-400 dark:text-gray-500">
                <input type="checkbox" checked disabled class="w-3.5 h-3.5 rounded border-gray-300 dark:border-gray-600 text-green-600">
                Delete source connectors
              </label>
              <label class="flex items-center gap-2 text-gray-400 dark:text-gray-500">
                <input type="checkbox" checked disabled class="w-3.5 h-3.5 rounded border-gray-300 dark:border-gray-600 text-green-600">
                Update / remove sink connector
              </label>
              <label class="flex items-center gap-2 text-gray-400 dark:text-gray-500">
                <input type="checkbox" checked disabled class="w-3.5 h-3.5 rounded border-gray-300 dark:border-gray-600 text-green-600">
                Stop CDC replication
              </label>
            </div>

            <hr class="border-gray-200 dark:border-gray-700">

            <!-- Optional -->
            <div class="space-y-1.5">
              <p class="font-medium text-gray-400 dark:text-gray-500 uppercase tracking-wider">Optional</p>
              <label class="flex items-center gap-2 text-gray-700 dark:text-gray-300 cursor-pointer">
                <input type="checkbox" x-model="deleteDbTopics"
                       class="w-3.5 h-3.5 rounded border-gray-300 dark:border-gray-600 text-red-600 focus:ring-red-500">
                Delete Kafka topics
              </label>
              <label class="flex items-center gap-2 text-gray-700 dark:text-gray-300 cursor-pointer">
                <input type="checkbox" x-model="deleteDbTables"
                       class="w-3.5 h-3.5 rounded border-gray-300 dark:border-gray-600 text-red-600 focus:ring-red-500">
                Drop target tables
              </label>
            </div>

            <hr class="border-gray-200 dark:border-gray-700">
          </div>
        </template>

        <!-- No connectors - simple message -->
        <template x-if="deletingDbConnectors === 0">
          <p class="text-gray-500 dark:text-gray-400">
            This database has no active connectors. Only the connection record will be removed.
          </p>
        </template>

        <!-- Confirm checkbox -->
        <label class="flex items-center gap-2 text-gray-900 dark:text-white cursor-pointer">
          <input type="checkbox" x-model="deleteDbConfirmed"
                 class="w-3.5 h-3.5 rounded border-gray-300 dark:border-gray-600 text-red-600 focus:ring-red-500">
          I understand this cannot be undone
        </label>
      </div>

      <!-- Footer -->
      <div class="px-5 py-3 bg-gray-50 dark:bg-gray-900/50 flex justify-end gap-2">
        <button type="button"
                @click="deletingDatabase = null; deleteDbConfirmed = false; deleteDbTopics = false; deleteDbTables = false"
                :disabled="isDeletingConnection"
                class="px-3 py-1.5 text-xs font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition disabled:opacity-50 disabled:cursor-not-allowed">
          Cancel
        </button>
        <button @click="deleteConnection()"
                :disabled="!deleteDbConfirmed || isDeletingConnection"
                class="px-3 py-1.5 text-xs font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed inline-flex items-center gap-1.5">
          <svg x-show="isDeletingConnection" class="animate-spin h-3.5 w-3.5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <span x-text="isDeletingConnection ? 'Deleting...' : 'Delete'"></span>
        </button>
      </div>
    </div>
      </div>
    </div>
  </div>

</div>


<script>
// Alpine.js global function for saving database
document.addEventListener('alpine:init', () => {
  Alpine.data('clientDetail', () => ({
    async saveDatabase() {
      // Get form data from test result
      const formDataToSend = new FormData();
      
      // Add all form fields
      for (const key in this.testResult.formData) {
        formDataToSend.append(key, this.testResult.formData[key]);
      }
      
      const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      formDataToSend.append('csrfmiddlewaretoken', csrfToken);
      
      try {
        const response = await fetch(this.testResult.url, {
          method: 'POST',
          body: formDataToSend,
          headers: {
            'X-CSRFToken': csrfToken,
            'HX-Request': 'true'
          }
        });

        if (response.ok) {
          const html = await response.text();
          document.getElementById('databases-content').innerHTML = html;
          this.showTestResultModal = false;
          this.showDatabaseModal = false;
          
          // Re-initialize HTMX for new content
          if (window.htmx) {
            htmx.process(document.getElementById('databases-content'));
          }
        } else {
          alert('Failed to save database connection');
        }
      } catch (error) {
        console.error('Error saving database:', error);
        alert('Error saving database: ' + error.message);
      }
    }
  }));
});
</script>

{% endblock %}

