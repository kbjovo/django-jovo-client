{% extends "index.html" %}
{% load cotton %}

{% block content %}

<!-- Show Django messages as toasts -->
{% if messages %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        {% for message in messages %}
            showToast('{{ message.tags }}', '{{ message }}');
        {% endfor %}
    });
</script>
{% endif %}

<!-- Monitoring Dashboard Container (no vertical scroll on container) -->
<div class="h-full flex flex-col overflow-hidden">

  <!-- Header Section (fixed, no scroll) -->
  <div class="flex-shrink-0 px-6 py-4 border-b border-gray-200 dark:border-gray-700">
    <div class="flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Real-Time Monitoring</h1>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">Monitor active replication connectors and their health status</p>
      </div>
      <button
        onclick="window.location.reload()"
        class="inline-flex text-sm items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-lg shadow-sm hover:shadow transition">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        Refresh
      </button>
    </div>
  </div>

  <!-- Scrollable Content Area -->
  <div id="monitoring-root"
       class="flex-1 overflow-y-auto px-6 py-6"
       x-data="{
         selectedClients: [],
         connectorSearch: '',
         open: false,
         allItems: [
           {% for item in monitoring_data %}
           { configPk: {{ item.config.pk }}, clientId: {{ item.config.client_database.client.pk }}, connectorName: '{{ item.config.connector_name|escapejs }}', healthy: {{ item.is_healthy|yesno:'true,false' }}, errors: {{ item.error_count|default:0 }} }{% if not forloop.last %},{% endif %}
           {% endfor %}
         ],
         toggle(id) {
           const idx = this.selectedClients.indexOf(id);
           if (idx === -1) this.selectedClients.push(id);
           else this.selectedClients.splice(idx, 1);
         },
         isVisible(clientId, connectorName) {
           const clientOk = this.selectedClients.length === 0 || this.selectedClients.includes(clientId);
           const nameOk = this.connectorSearch === '' || connectorName.toLowerCase().includes(this.connectorSearch.toLowerCase());
           return clientOk && nameOk;
         },
         clearAll() { this.selectedClients = []; this.connectorSearch = ''; },
         get filtered() {
           return this.allItems.filter(i => {
             const clientOk = this.selectedClients.length === 0 || this.selectedClients.includes(i.clientId);
             const nameOk = this.connectorSearch === '' || i.connectorName.toLowerCase().includes(this.connectorSearch.toLowerCase());
             return clientOk && nameOk;
           });
         },
         get activeCount() { return this.filtered.length; },
         get healthyCount() { return this.filtered.filter(i => i.healthy).length; },
         get unhealthyCount() { return this.filtered.filter(i => !i.healthy).length; },
         get errorCount() { return this.filtered.reduce((s, i) => s + i.errors, 0); },
       }">

    <!-- Filter Bar -->
    {% if monitoring_data %}
    <div class="mb-6 flex items-center gap-3 flex-wrap">

      <!-- Connector name search -->
      <div class="relative w-64">
        <div class="absolute inset-y-0 left-3 flex items-center pointer-events-none">
          <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
        </div>
        <input type="text"
               x-model="connectorSearch"
               class="w-full pl-10 pr-10 py-1.5 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
               placeholder="Search connectors...">
        <button type="button"
                x-show="connectorSearch !== ''" x-cloak
                @click="connectorSearch = ''"
                class="absolute inset-y-0 right-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      {% if clients %}
      <!-- Multi-select dropdown -->
      <div class="relative" @click.away="open = false">
        <button @click="open = !open"
                class="inline-flex items-center gap-2 px-4 py-2 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg text-sm font-medium text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition shadow-sm">
          <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
          </svg>
          <span x-text="selectedClients.length === 0 ? 'All Clients' : selectedClients.length + ' Client' + (selectedClients.length > 1 ? 's' : '') + ' Selected'"></span>
          <svg class="w-4 h-4 transition-transform" :class="open ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
          </svg>
        </button>

        <!-- Dropdown -->
        <div x-show="open" x-transition x-cloak
             class="absolute z-20 mt-2 w-64 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg overflow-hidden">
          {% for client in clients %}
          <label @click.stop
                 class="flex items-center gap-3 px-4 py-2.5 hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer transition">
            <input type="checkbox"
                   :checked="selectedClients.includes({{ client.id }})"
                   @change="toggle({{ client.id }})"
                   class="w-4 h-4 rounded border-gray-300 dark:border-gray-600 text-blue-600 focus:ring-blue-500">
            <span class="text-sm text-gray-700 dark:text-gray-300">{{ client.name }}</span>
          </label>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Clear filter button -->
      <button x-show="selectedClients.length > 0 || connectorSearch !== ''" x-cloak
              @click="clearAll()"
              class="inline-flex items-center gap-1 px-3 py-2 text-sm text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200 transition">
        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        Clear
      </button>
    </div>
    {% endif %}

    <!-- Statistics Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
      <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 flex items-center gap-3">
        <span class="text-2xl font-bold text-gray-900 dark:text-white" x-text="activeCount"></span>
        <span class="text-sm text-gray-600 dark:text-gray-400">Active</span>
      </div>
      <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 flex items-center gap-3">
        <span class="text-2xl font-bold text-green-600 dark:text-green-400" x-text="healthyCount"></span>
        <span class="text-sm text-gray-600 dark:text-gray-400">Healthy</span>
      </div>
      <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 flex items-center gap-3">
        <span class="text-2xl font-bold" :class="unhealthyCount > 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-900 dark:text-white'" x-text="unhealthyCount"></span>
        <span class="text-sm text-gray-600 dark:text-gray-400">Unhealthy</span>
      </div>
      <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-4 py-3 flex items-center gap-3">
        <span class="text-2xl font-bold" :class="errorCount > 0 ? 'text-red-600 dark:text-red-400' : 'text-gray-900 dark:text-white'" x-text="errorCount"></span>
        <span class="text-sm text-gray-600 dark:text-gray-400">Errors</span>
      </div>
    </div>

    <!-- Monitoring Grid -->
    {% if monitoring_data %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      {% for item in monitoring_data %}
      <div id="card-{{ item.config.pk }}"
           data-config-pk="{{ item.config.pk }}"
           data-connector-name="{{ item.config.connector_name|escapejs }}"
           data-poll-url="{% url 'connector_dashboard_card_api' item.config.pk %}"
           x-show="isVisible({{ item.config.client_database.client.pk }}, '{{ item.config.connector_name|escapejs }}')" x-transition
           class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm overflow-hidden">

        <!-- Header -->
        <div id="card-header-{{ item.config.pk }}"
             class="px-5 py-4 border-b border-gray-200 dark:border-gray-700 {% if item.is_healthy %}bg-green-50 dark:bg-green-900/10{% else %}bg-red-50 dark:bg-red-900/10{% endif %}">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3 min-w-0 flex-1">

              <!-- Status Indicator -->
              <div id="status-icon-{{ item.config.pk }}" class="flex-shrink-0">
                {% if item.is_healthy %}
                <div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
                  <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                {% else %}
                <div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
                  <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                  </svg>
                </div>
                {% endif %}
              </div>

              <!-- Client Info -->
              <div class="min-w-0 flex-1">
                <h3 class="text-base font-semibold text-gray-900 dark:text-white font-mono truncate">
                  {{ item.config.connector_name }}
                </h3>
                <p class="text-xs text-gray-600 dark:text-gray-400 truncate">
                  {{ item.config.client_database.client.name }} &middot; {{ item.config.client_database.connection_name }}
                </p>
              </div>
            </div>

            <!-- Badges -->
            <div class="flex items-center gap-1.5 flex-shrink-0">
              {% if item.config.processing_mode == 'batch' %}
              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400">Batch</span>
              {% else %}
              <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400">CDC</span>
              {% endif %}
              <span id="state-badge-{{ item.config.pk }}"
                    class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold
                {% if item.connector_state == 'RUNNING' %}bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400
                {% elif item.connector_state == 'FAILED' or item.connector_state == 'ERROR' %}bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400
                {% elif item.connector_state == 'PAUSED' %}bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400
                {% else %}bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300{% endif %}">
                {{ item.connector_state }}
              </span>
            </div>
          </div>
        </div>

        <!-- Body -->
        <div class="p-5 space-y-4">

          <!-- Sync Status Row -->
          <div class="flex items-center justify-between">
            <p class="text-xs font-medium text-gray-500 dark:text-gray-400">Sync Status</p>
            <div id="sync-value-{{ item.config.pk }}">
              <!-- Spinner shown until first AJAX response -->
              <svg class="w-4 h-4 animate-spin text-gray-300 dark:text-gray-600" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
              </svg>
            </div>
          </div>

          <!-- Database -->
          <div>
            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-1">Database</p>
            <p class="text-sm text-gray-900 dark:text-white truncate">{{ item.config.client_database.connection_name }}</p>
            <p class="text-xs text-gray-500 dark:text-gray-400 truncate">{{ item.config.client_database.db_type|upper }} @ {{ item.config.client_database.host }}:{{ item.config.client_database.port }}/{{ item.config.client_database.database_name }}</p>
          </div>

          <!-- Tasks (updated by AJAX) -->
          <div id="tasks-section-{{ item.config.pk }}">
            {% if item.tasks %}
            <p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Tasks ({{ item.tasks|length }})</p>
            <div class="space-y-2">
              {% for task in item.tasks %}
              <div class="rounded-lg bg-gray-50 dark:bg-gray-700/50 overflow-hidden">
                <div class="flex items-center justify-between p-2">
                  <div class="flex items-center gap-2 min-w-0 flex-1">
                    {% if task.state == 'RUNNING' %}
                    <div class="flex-shrink-0 w-2 h-2 rounded-full bg-green-500"></div>
                    {% elif task.state == 'FAILED' %}
                    <div class="flex-shrink-0 w-2 h-2 rounded-full bg-red-500"></div>
                    {% else %}
                    <div class="flex-shrink-0 w-2 h-2 rounded-full bg-gray-400"></div>
                    {% endif %}
                    <span class="text-xs text-gray-700 dark:text-gray-300 font-mono truncate">Task {{ task.id }}</span>
                  </div>
                  <span class="text-xs font-medium flex-shrink-0
                    {% if task.state == 'RUNNING' %}text-green-600 dark:text-green-400
                    {% elif task.state == 'FAILED' %}text-red-600 dark:text-red-400
                    {% else %}text-gray-600 dark:text-gray-400{% endif %}">
                    {{ task.state }}
                  </span>
                </div>
                {% if task.state == 'FAILED' and task.trace %}
                <button class="w-full text-left px-2 pb-2 group"
                        onclick="showErrorModal('Task {{ task.id }} — Error Trace', '{{ task.trace|escapejs }}')">
                  <p class="text-xs text-red-600 dark:text-red-400 font-mono truncate">{{ task.trace|truncatechars:120 }}</p>
                  <p class="text-xs text-red-400 dark:text-red-500 mt-0.5 group-hover:underline">Click to view full trace &rarr;</p>
                </button>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% endif %}
          </div>

          <!-- Connector-level error trace (updated by AJAX) -->
          <div id="connector-trace-{{ item.config.pk }}">
            {% if item.connector_trace %}
            <div class="rounded-lg bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-900/30 overflow-hidden">
              <button class="w-full text-left p-3 group"
                      onclick="showErrorModal('{{ item.config.connector_name }} — Connector Error', '{{ item.connector_trace|escapejs }}')">
                <p class="text-xs font-medium text-red-800 dark:text-red-400 mb-1">Connector Error</p>
                <p class="text-xs text-red-700 dark:text-red-300 font-mono truncate">{{ item.connector_trace|truncatechars:120 }}</p>
                <p class="text-xs text-red-400 dark:text-red-500 mt-1 group-hover:underline">Click to view full trace &rarr;</p>
              </button>
            </div>
            {% endif %}
          </div>

          <!-- Error Message (updated by AJAX) -->
          <div id="error-msg-{{ item.config.pk }}">
            {% if item.error_message %}
            <div class="rounded-lg bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-900/30 overflow-hidden">
              <button class="w-full text-left p-3 group"
                      onclick="showErrorModal('{{ item.config.connector_name }} — Error', '{{ item.error_message|escapejs }}')">
                <p class="text-xs font-medium text-red-800 dark:text-red-400 mb-1">Error</p>
                <p class="text-xs text-red-700 dark:text-red-300 truncate">{{ item.error_message }}</p>
                <p class="text-xs text-red-400 dark:text-red-500 mt-1 group-hover:underline">Click to view full error &rarr;</p>
              </button>
            </div>
            {% endif %}
          </div>

          <!-- Actions -->
          <div class="flex items-center gap-2 pt-2 border-t border-gray-200 dark:border-gray-700">
            <a href="{% url 'connector_monitor' item.config.pk %}"
               class="flex-1 inline-flex justify-center items-center gap-1 px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
              </svg>
              View Details
            </a>
            <a href="{% url 'client_detail' item.config.client_database.client.pk %}"
               class="flex-1 inline-flex justify-center items-center gap-1 px-3 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 text-xs font-medium rounded-lg transition">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              View Client
            </a>
          </div>
        </div>

      </div>
      {% endfor %}
    </div>

    {% else %}
    <!-- Empty State -->
    <div class="bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl shadow-sm p-12">
      <div class="text-center">
        <svg class="mx-auto h-16 w-16 text-gray-300 dark:text-gray-600 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
        </svg>
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">No active replications</h3>
        <p class="text-sm text-gray-500 dark:text-gray-400 mb-4">
          Start a replication to see real-time monitoring data here.
        </p>
        <a href="{% url 'connectors_list' %}" class="inline-flex items-center text-sm text-blue-600 hover:text-blue-700 dark:text-blue-400 font-medium">
          View all connectors →
        </a>
      </div>
    </div>
    {% endif %}

  </div>

</div>

<!-- Error Trace Modal -->
<div id="error-modal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeErrorModal()"></div>
  <!-- Panel -->
  <div class="absolute inset-0 flex items-center justify-center p-4 pointer-events-none">
    <div class="relative bg-white dark:bg-gray-900 rounded-xl shadow-2xl w-full max-w-3xl max-h-[80vh] flex flex-col pointer-events-auto">
      <!-- Header -->
      <div class="flex items-start justify-between px-5 py-4 border-b border-gray-200 dark:border-gray-700 flex-shrink-0">
        <div class="min-w-0 flex-1 pr-4">
          <p class="text-xs font-semibold text-red-500 uppercase tracking-wide mb-0.5">Error Details</p>
          <h3 id="error-modal-title" class="text-sm font-semibold text-gray-900 dark:text-white font-mono break-all"></h3>
        </div>
        <button onclick="closeErrorModal()"
                class="flex-shrink-0 p-1 rounded-md text-gray-400 hover:text-gray-600 dark:hover:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-800 transition">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      <!-- Scrollable body -->
      <div class="overflow-y-auto flex-1 p-5">
        <pre id="error-modal-body" class="text-xs text-red-700 dark:text-red-300 font-mono whitespace-pre-wrap break-words leading-relaxed"></pre>
      </div>
      <!-- Footer -->
      <div class="flex justify-end px-5 py-3 border-t border-gray-200 dark:border-gray-700 flex-shrink-0">
        <button onclick="closeErrorModal()"
                class="px-4 py-2 text-sm font-medium bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-lg transition">
          Close
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// ─────────────────────────────────────────────────────────────
// Error modal
// ─────────────────────────────────────────────────────────────
function showErrorModal(title, trace) {
  document.getElementById('error-modal-title').textContent = title;
  document.getElementById('error-modal-body').textContent = trace;
  document.getElementById('error-modal').classList.remove('hidden');
  document.body.style.overflow = 'hidden';
}
function closeErrorModal() {
  document.getElementById('error-modal').classList.add('hidden');
  document.body.style.overflow = '';
}
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') closeErrorModal();
});

// ─────────────────────────────────────────────────────────────
// Sync status badge renderer
// ─────────────────────────────────────────────────────────────
function renderSyncBadge(sync) {
  if (!sync || !sync.status) {
    return '<span class="text-xs text-gray-400 dark:text-gray-500">—</span>';
  }

  const s = sync.status;

  if (s === 'snapshot_in_progress') {
    return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400">
      <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
      </svg>
      Snapshot in progress
    </span>`;
  }

  if (s === 'unable_to_check') {
    return `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-500 dark:bg-gray-700 dark:text-gray-400">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path>
      </svg>
      Unable to check
    </span>`;
  }

  const n = sync.in_sync_count;
  const t = sync.total_count;
  const tip = `${sync.synced} synced · ${sync.not_synced} not synced`;

  if (s === 'rows_in_sync') {
    return `<span title="${tip}" class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400 cursor-help">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      ${n}/${t}
    </span>`;
  }

  if (s === 'yet_to_be_synced') {
    return `<span title="${tip}" class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-700 dark:bg-amber-900/30 dark:text-amber-400 cursor-help">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
      </svg>
      ${n}/${t}
    </span>`;
  }

  if (s === 'syncing') {
    return `<span title="${tip}" class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400 cursor-help">
      <svg class="w-3 h-3 animate-spin" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path>
      </svg>
      ${n}/${t}
    </span>`;
  }

  if (s === 'not_synced') {
    return `<span title="${tip}" class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400 cursor-help">
      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
      ${n}/${t}
    </span>`;
  }

  return '<span class="text-xs text-gray-400 dark:text-gray-500">—</span>';
}

// ─────────────────────────────────────────────────────────────
// Tasks section renderer
// ─────────────────────────────────────────────────────────────
function renderTasks(tasks) {
  if (!tasks || tasks.length === 0) return '';
  const rows = tasks.map(task => {
    const dotColor = task.state === 'RUNNING' ? 'bg-green-500' : task.state === 'FAILED' ? 'bg-red-500' : 'bg-gray-400';
    const textColor = task.state === 'RUNNING' ? 'text-green-600 dark:text-green-400' : task.state === 'FAILED' ? 'text-red-600 dark:text-red-400' : 'text-gray-600 dark:text-gray-400';
    const traceHtml = (task.state === 'FAILED' && task.trace) ? `
      <button class="w-full text-left px-2 pb-2 group" onclick="showErrorModal('Task ${task.id} \u2014 Error Trace', ${JSON.stringify(task.trace)})">
        <p class="text-xs text-red-600 dark:text-red-400 font-mono truncate">${task.trace.substring(0, 120)}</p>
        <p class="text-xs text-red-400 dark:text-red-500 mt-0.5 group-hover:underline">Click to view full trace \u2192</p>
      </button>` : '';
    return `<div class="rounded-lg bg-gray-50 dark:bg-gray-700/50 overflow-hidden">
      <div class="flex items-center justify-between p-2">
        <div class="flex items-center gap-2 min-w-0 flex-1">
          <div class="flex-shrink-0 w-2 h-2 rounded-full ${dotColor}"></div>
          <span class="text-xs text-gray-700 dark:text-gray-300 font-mono truncate">Task ${task.id}</span>
        </div>
        <span class="text-xs font-medium flex-shrink-0 ${textColor}">${task.state}</span>
      </div>${traceHtml}
    </div>`;
  }).join('');
  return `<p class="text-xs font-medium text-gray-500 dark:text-gray-400 mb-2">Tasks (${tasks.length})</p>
    <div class="space-y-2">${rows}</div>`;
}

// ─────────────────────────────────────────────────────────────
// Card DOM updater
// ─────────────────────────────────────────────────────────────
function applyCardUpdate(pk, data) {
  const { card, sync } = data;

  // Header background
  const header = document.getElementById(`card-header-${pk}`);
  if (header) {
    header.className = 'px-5 py-4 border-b border-gray-200 dark:border-gray-700 ' +
      (card.is_healthy ? 'bg-green-50 dark:bg-green-900/10' : 'bg-red-50 dark:bg-red-900/10');
  }

  // Status icon
  const iconEl = document.getElementById(`status-icon-${pk}`);
  if (iconEl) {
    if (card.is_healthy) {
      iconEl.innerHTML = `<div class="w-10 h-10 rounded-full bg-green-100 dark:bg-green-900/30 flex items-center justify-center">
        <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>`;
    } else {
      iconEl.innerHTML = `<div class="w-10 h-10 rounded-full bg-red-100 dark:bg-red-900/30 flex items-center justify-center">
        <svg class="w-5 h-5 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
      </div>`;
    }
  }

  // State badge
  const badgeEl = document.getElementById(`state-badge-${pk}`);
  if (badgeEl) {
    const st = card.connector_state;
    let cls = 'inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold ';
    if (st === 'RUNNING') cls += 'bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400';
    else if (st === 'FAILED' || st === 'ERROR') cls += 'bg-red-100 text-red-700 dark:bg-red-900/30 dark:text-red-400';
    else if (st === 'PAUSED') cls += 'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400';
    else cls += 'bg-gray-100 text-gray-700 dark:bg-gray-700 dark:text-gray-300';
    badgeEl.className = cls;
    badgeEl.textContent = st;
  }

  // Sync status
  const syncEl = document.getElementById(`sync-value-${pk}`);
  if (syncEl) {
    syncEl.innerHTML = renderSyncBadge(sync);
  }

  // Tasks section
  const tasksEl = document.getElementById(`tasks-section-${pk}`);
  if (tasksEl) {
    tasksEl.innerHTML = renderTasks(card.tasks);
  }

  // Connector trace
  const traceEl = document.getElementById(`connector-trace-${pk}`);
  if (traceEl) {
    if (card.connector_trace) {
      const connectorName = document.getElementById(`card-${pk}`)?.dataset.connectorName || '';
      traceEl.innerHTML = `<div class="rounded-lg bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-900/30 overflow-hidden">
        <button class="w-full text-left p-3 group" onclick="showErrorModal(${JSON.stringify(connectorName + ' \u2014 Connector Error')}, ${JSON.stringify(card.connector_trace)})">
          <p class="text-xs font-medium text-red-800 dark:text-red-400 mb-1">Connector Error</p>
          <p class="text-xs text-red-700 dark:text-red-300 font-mono truncate">${card.connector_trace.substring(0, 120)}</p>
          <p class="text-xs text-red-400 dark:text-red-500 mt-1 group-hover:underline">Click to view full trace \u2192</p>
        </button>
      </div>`;
    } else {
      traceEl.innerHTML = '';
    }
  }

  // Error message
  const errEl = document.getElementById(`error-msg-${pk}`);
  if (errEl) {
    if (card.error_message) {
      const connectorName = document.getElementById(`card-${pk}`)?.dataset.connectorName || '';
      errEl.innerHTML = `<div class="rounded-lg bg-red-50 dark:bg-red-900/10 border border-red-200 dark:border-red-900/30 overflow-hidden">
        <button class="w-full text-left p-3 group" onclick="showErrorModal(${JSON.stringify(connectorName + ' \u2014 Error')}, ${JSON.stringify(card.error_message)})">
          <p class="text-xs font-medium text-red-800 dark:text-red-400 mb-1">Error</p>
          <p class="text-xs text-red-700 dark:text-red-300 truncate">${card.error_message}</p>
          <p class="text-xs text-red-400 dark:text-red-500 mt-1 group-hover:underline">Click to view full error \u2192</p>
        </button>
      </div>`;
    } else {
      errEl.innerHTML = '';
    }
  }

  // Update Alpine summary stats
  const root = document.getElementById('monitoring-root');
  if (root && window.Alpine) {
    const alpineData = Alpine.$data(root);
    if (alpineData && alpineData.allItems) {
      const item = alpineData.allItems.find(i => i.configPk === pk);
      if (item) {
        item.healthy = card.is_healthy;
        item.errors = card.error_count;
      }
    }
  }
}

// ─────────────────────────────────────────────────────────────
// Per-card polling (15s interval, no page reload)
// ─────────────────────────────────────────────────────────────
function pollCard(pk, url) {
  fetch(url)
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        applyCardUpdate(pk, data);
      }
    })
    .catch(() => {
      // Network error — leave card as-is, retry on next interval
    });
}

document.addEventListener('DOMContentLoaded', function() {
  const cards = document.querySelectorAll('[data-config-pk]');
  cards.forEach(function(card) {
    const pk = parseInt(card.dataset.configPk, 10);
    const url = card.dataset.pollUrl;
    // Fire immediately so sync status spinner resolves fast
    pollCard(pk, url);
    // Then poll every 15 seconds
    setInterval(() => pollCard(pk, url), 15000);
  });
});
</script>

{% endblock %}