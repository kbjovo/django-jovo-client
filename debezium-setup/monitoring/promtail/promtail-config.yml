server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    backoff_config:
      min_period: 100ms
      max_period: 10s
      max_retries: 10
    timeout: 10s
    # Add batch settings for better performance
    batchwait: 1s
    batchsize: 1048576  # 1MB

scrape_configs:
  # ============================================
  # ALL DOCKER CONTAINERS - Universal Capture
  # ============================================
  - job_name: docker-containers
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: name
            values: ['.*']  # Capture ALL containers
    
    relabel_configs:
      # Container name
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: container_name
      
      # Container ID (first 12 chars for readability)
      - source_labels: ['__meta_docker_container_id']
        regex: '(.{12}).*'
        target_label: container_id
      
      # Container image
      - source_labels: ['__meta_docker_container_image']
        target_label: image
      
      # Compose project
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: compose_project
      
      # Compose service
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: compose_service
      
      # Set path to container logs
      - source_labels: ['__meta_docker_container_id']
        target_label: __path__
        replacement: /var/lib/docker/containers/$1*/*.log
    
    pipeline_stages:
      # Parse Docker JSON log format
      - json:
          expressions:
            output: log
            stream: stream
            timestamp: time
      
      # Extract timestamp
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      # Detect service type from container name
      - regex:
          source: container_name
          expression: '^(?P<service_type>django|celery-worker|celery-consumer|celery-beat|mysql|redis|kafka|prometheus|grafana|loki|promtail|schema-registry|kafka-connect|cadvisor|node-exporter).*'
      
      - labels:
          service_type:
          stream:
      
      # Try to parse as JSON if it's structured logging
      - match:
          selector: '{service_type=~"django|celery.*"}'
          stages:
            - json:
                expressions:
                  level: level
                  logger: logger
                  module: module
                  operation: operation
                  client_id: client_id
                  connector_name: connector_name
                  table_name: table_name
                  duration: duration_seconds
                  error_type: error_type
                  status: status
                  task_name: task_name
                  queue: queue
            
            - labels:
                level:
                operation:
                status:
      
      # Output the log message
      - output:
          source: output

  # ============================================
  # DJANGO APPLICATION - JSON Logs
  # ============================================
  - job_name: django-json
    static_configs:
      - targets:
          - localhost
        labels:
          job: django-json
          service: django
          log_type: application
          __path__: /app/logs/application.json
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            logger: logger
            message: message
            module: module
            function: function
            line: line
            client_id: client_id
            connector_name: connector_name
            table_name: table_name
            operation: operation
            duration: duration_seconds
            error_type: error_type
            error_message: error_message
            status: status
      
      - labels:
          level:
          logger:
          module:
          operation:
          status:
      
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      - output:
          source: message

  # ============================================
  # CDC-SPECIFIC LOGS
  # ============================================
  - job_name: cdc-operations
    static_configs:
      - targets:
          - localhost
        labels:
          job: cdc-operations
          service: cdc
          log_type: cdc_operations
          __path__: /app/logs/cdc.json
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            client_id: client_id
            connector_name: connector_name
            table_name: table_name
            operation: operation
            duration: duration_seconds
            status: status
            error_type: error_type
      
      - labels:
          level:
          operation:
          status:
      
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      - output:
          source: message

  # ============================================
  # CELERY TASK LOGS
  # ============================================
  - job_name: celery-tasks
    static_configs:
      - targets:
          - localhost
        labels:
          job: celery-tasks
          service: celery
          log_type: task_execution
          __path__: /app/logs/celery.json
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            task_name: task_name
            task_id: task_id
            queue: queue
            operation: operation
            duration: duration_seconds
            status: status
            client_id: client_id
      
      - labels:
          level:
          queue:
          operation:
          status:
      
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      - output:
          source: message

  # ============================================
  # ERROR LOGS - High Priority
  # ============================================
  - job_name: errors
    static_configs:
      - targets:
          - localhost
        labels:
          job: errors
          service: django
          log_type: errors_only
          severity: error
          __path__: /app/logs/errors.json
    
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            error_type: error_type
            error_message: error_message
            client_id: client_id
            operation: operation
            module: module
            logger: logger
      
      - labels:
          level:
          error_type:
          operation:
          module:
      
      - timestamp:
          source: timestamp
          format: RFC3339Nano
      
      - output:
          source: message

  # ============================================
  # LEGACY TEXT LOGS (Backward Compatibility)
  # ============================================
  - job_name: django-text
    static_configs:
      - targets:
          - localhost
        labels:
          job: django-text
          service: django
          log_type: text_format
          __path__: /app/logs/replication.log
    
    pipeline_stages:
      - regex:
          expression: '^\[(?P<level>\w+)\]\s+(?P<timestamp>[\d-]+\s+[\d:]+)\s+(?P<logger>\S+)\s+(?P<module>\S+)\.(?P<function>\S+):(?P<line>\d+)\s+-\s+(?P<message>.*)$'
      
      - labels:
          level:
          logger:
          module:
      
      - timestamp:
          source: timestamp
          format: '2006-01-02 15:04:05'
      
      - output:
          source: message