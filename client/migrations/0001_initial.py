# Generated by Django 5.2.7 on 2025-12-22 06:27

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='Client',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('name', models.CharField(max_length=100)),
                ('email', models.EmailField(db_index=True, max_length=254, unique=True)),
                ('phone', models.CharField(db_index=True, max_length=10, unique=True)),
                ('db_name', models.CharField(db_index=True, default='temp', help_text='Database name where replicated data will be stored', max_length=20, unique=True)),
                ('company_name', models.CharField(blank=True, max_length=255)),
                ('address', models.TextField(blank=True)),
                ('city', models.CharField(blank=True, max_length=100)),
                ('state', models.CharField(blank=True, db_index=True, max_length=100)),
                ('country', models.CharField(blank=True, default='India', max_length=100)),
                ('postal_code', models.CharField(blank=True, max_length=20, null=True)),
                ('status', models.CharField(choices=[('active', 'Active'), ('inactive', 'Inactive'), ('deleted', 'Deleted')], default='active', max_length=20)),
                ('replication_enabled', models.BooleanField(default=False, help_text='Enable real-time replication for this client')),
                ('replication_status', models.CharField(choices=[('not_configured', 'Not Configured'), ('configured', 'Configured'), ('active', 'Active'), ('paused', 'Paused'), ('error', 'Error')], default='not_configured', max_length=20)),
                ('last_replication_at', models.DateTimeField(blank=True, help_text='Last time data was replicated', null=True)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
            ],
            options={
                'verbose_name': 'Client',
                'verbose_name_plural': 'Clients',
                'db_table': 'client',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='ClientDatabase',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('connection_name', models.CharField(db_index=True, max_length=100)),
                ('db_type', models.CharField(choices=[('mysql', 'MySQL'), ('postgresql', 'PostgreSQL'), ('sqlite', 'SQLite'), ('oracle', 'Oracle'), ('mssql', 'SQL Server')], default='mysql', max_length=20)),
                ('host', models.CharField(db_index=True, max_length=255)),
                ('port', models.PositiveIntegerField(default=3306)),
                ('username', models.CharField(max_length=100)),
                ('password', models.CharField(max_length=255)),
                ('database_name', models.CharField(max_length=100)),
                ('oracle_connection_mode', models.CharField(blank=True, choices=[('service', 'Service Name (Recommended)'), ('sid', 'SID (Legacy)')], default='service', help_text='Oracle connection type: service name (PDB, Docker, Cloud) or SID (legacy)', max_length=20, null=True)),
                ('is_primary', models.BooleanField(default=False, help_text='Source database for CDC')),
                ('is_target', models.BooleanField(default=False, help_text='Target database where replicated data will be stored')),
                ('connection_status', models.CharField(choices=[('success', 'Success'), ('failed', 'Failed'), ('inactive', 'Inactive')], default='success', max_length=20)),
                ('last_checked', models.DateTimeField(blank=True, null=True)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('client', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='client_databases', to='client.client')),
            ],
            options={
                'verbose_name': 'Client Database',
                'verbose_name_plural': 'Client Databases',
                'db_table': 'client_databases',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='ReplicationConfig',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('sync_type', models.CharField(choices=[('full', 'Full Refresh'), ('incremental', 'Incremental Sync'), ('realtime', 'Real-time CDC')], default='realtime', help_text='Type of synchronization', max_length=20)),
                ('sync_frequency', models.CharField(choices=[('realtime', 'Real-time (CDC)'), ('every_1min', 'Every 1 minute'), ('every_5min', 'Every 5 minutes'), ('every_15min', 'Every 15 minutes'), ('every_30min', 'Every 30 minutes'), ('hourly', 'Hourly'), ('daily', 'Daily'), ('manual', 'Manual Only')], default='realtime', help_text='How often to sync (ignored for real-time CDC)', max_length=20)),
                ('status', models.CharField(choices=[('configured', 'Configured'), ('active', 'Active'), ('paused', 'Paused'), ('error', 'Error'), ('disabled', 'Disabled')], default='configured', max_length=20)),
                ('is_active', models.BooleanField(default=False)),
                ('last_sync_at', models.DateTimeField(blank=True, null=True)),
                ('next_sync_at', models.DateTimeField(blank=True, null=True)),
                ('last_success_at', models.DateTimeField(blank=True, null=True)),
                ('connector_name', models.CharField(blank=True, help_text='Debezium connector name in Kafka Connect', max_length=255, null=True)),
                ('connector_version', models.IntegerField(default=1, help_text='Version number for the connector (e.g., 1 for _v_1, 2 for _v_2)')),
                ('kafka_topic_prefix', models.CharField(blank=True, help_text='Kafka topic prefix for this connector', max_length=255, null=True)),
                ('auto_create_tables', models.BooleanField(default=True, help_text="Automatically create tables if they don't exist")),
                ('drop_before_sync', models.BooleanField(default=False, help_text='Drop and recreate tables (only for full refresh)')),
                ('connector_state', models.CharField(blank=True, help_text='Debezium connector state (RUNNING/PAUSED/FAILED/etc)', max_length=50, null=True)),
                ('consumer_state', models.CharField(default='UNKNOWN', help_text='Kafka consumer state (RUNNING/STOPPED/ERROR)', max_length=50)),
                ('consumer_task_id', models.CharField(blank=True, help_text='Celery task ID for running consumer', max_length=100, null=True)),
                ('consumer_last_heartbeat', models.DateTimeField(blank=True, help_text='Last heartbeat from consumer (updated every 30s)', null=True)),
                ('last_error_message', models.TextField(blank=True, help_text='Last error message for debugging', null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('client_database', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='replication_configs', to='client.clientdatabase')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='replication_configs_created', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Replication Configuration',
                'verbose_name_plural': 'Replication Configurations',
                'db_table': 'replication_config',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='ReplicationJob',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('job_id', models.CharField(db_index=True, max_length=100, unique=True)),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('running', 'Running'), ('success', 'Success'), ('partial_success', 'Partial Success'), ('failed', 'Failed'), ('cancelled', 'Cancelled')], db_index=True, default='pending', max_length=20)),
                ('trigger', models.CharField(choices=[('scheduled', 'Scheduled'), ('manual', 'Manual'), ('api', 'API'), ('auto', 'Automatic'), ('retry', 'Retry')], default='scheduled', max_length=20)),
                ('started_at', models.DateTimeField(blank=True, null=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('duration_seconds', models.FloatField(blank=True, null=True)),
                ('tables_processed', models.IntegerField(default=0)),
                ('tables_succeeded', models.IntegerField(default=0)),
                ('tables_failed', models.IntegerField(default=0)),
                ('rows_read', models.BigIntegerField(default=0)),
                ('rows_written', models.BigIntegerField(default=0)),
                ('rows_updated', models.BigIntegerField(default=0)),
                ('rows_failed', models.BigIntegerField(default=0)),
                ('error_message', models.TextField(blank=True, null=True)),
                ('error_traceback', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('replication_config', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='jobs', to='client.replicationconfig')),
            ],
            options={
                'verbose_name': 'Replication Job',
                'verbose_name_plural': 'Replication Jobs',
                'db_table': 'replication_job',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='TableMapping',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('source_table', models.CharField(max_length=255)),
                ('source_schema', models.CharField(blank=True, max_length=255, null=True)),
                ('target_table', models.CharField(help_text="Table name in client's database (can be different from source)", max_length=255)),
                ('target_schema', models.CharField(blank=True, default='', help_text='Schema in client database (leave empty for default)', max_length=255)),
                ('is_enabled', models.BooleanField(default=True)),
                ('sync_type', models.CharField(blank=True, choices=[('full', 'Full Refresh'), ('incremental', 'Incremental'), ('realtime', 'Real-time CDC')], help_text='Leave empty to inherit from ReplicationConfig', max_length=20)),
                ('sync_frequency', models.CharField(blank=True, choices=[('realtime', 'Real-time (CDC)'), ('every_1min', 'Every 1 minute'), ('every_5min', 'Every 5 minutes'), ('every_15min', 'Every 15 minutes'), ('every_30min', 'Every 30 minutes'), ('hourly', 'Hourly'), ('daily', 'Daily'), ('manual', 'Manual Only')], help_text='Leave empty to inherit from ReplicationConfig', max_length=20)),
                ('incremental_column', models.CharField(blank=True, help_text='Column to track for incremental sync (e.g., updated_at, id)', max_length=255, null=True)),
                ('incremental_column_type', models.CharField(blank=True, choices=[('timestamp', 'Timestamp'), ('integer', 'Integer/ID'), ('datetime', 'DateTime')], default='timestamp', max_length=50)),
                ('last_incremental_value', models.CharField(blank=True, help_text='Last synced value of incremental column', max_length=255, null=True)),
                ('conflict_resolution', models.CharField(choices=[('source_wins', 'Source Always Wins'), ('target_wins', 'Target Always Wins'), ('newest_wins', 'Newest Timestamp Wins'), ('manual', 'Manual Resolution')], default='source_wins', help_text='How to handle conflicts during sync', max_length=20)),
                ('total_rows_synced', models.BigIntegerField(default=0)),
                ('last_sync_at', models.DateTimeField(blank=True, null=True)),
                ('last_sync_duration', models.FloatField(blank=True, help_text='Duration in seconds', null=True)),
                ('last_sync_status', models.CharField(blank=True, choices=[('success', 'Success'), ('failed', 'Failed'), ('partial', 'Partial Success')], default='success', max_length=20)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('replication_config', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='table_mappings', to='client.replicationconfig')),
            ],
            options={
                'verbose_name': 'Table Mapping',
                'verbose_name_plural': 'Table Mappings',
                'db_table': 'table_mapping',
                'ordering': ['source_table'],
            },
        ),
        migrations.CreateModel(
            name='SchemaVersion',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('version', models.IntegerField()),
                ('schema_snapshot', models.JSONField(help_text='Complete table schema (columns, types, constraints)')),
                ('changes', models.JSONField(blank=True, help_text='List of changes from previous version', null=True)),
                ('detected_at', models.DateTimeField(auto_now_add=True)),
                ('detected_by_job', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to='client.replicationjob')),
                ('table_mapping', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='schema_versions', to='client.tablemapping')),
            ],
            options={
                'verbose_name': 'Schema Version',
                'verbose_name_plural': 'Schema Versions',
                'db_table': 'schema_versions',
                'ordering': ['-version'],
            },
        ),
        migrations.CreateModel(
            name='ReplicationLog',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('status', models.CharField(choices=[('pending', 'Pending'), ('running', 'Running'), ('success', 'Success'), ('failed', 'Failed'), ('skipped', 'Skipped')], db_index=True, default='pending', max_length=20)),
                ('started_at', models.DateTimeField(blank=True, null=True)),
                ('completed_at', models.DateTimeField(blank=True, null=True)),
                ('duration_seconds', models.FloatField(blank=True, null=True)),
                ('rows_read', models.BigIntegerField(default=0)),
                ('rows_inserted', models.BigIntegerField(default=0)),
                ('rows_updated', models.BigIntegerField(default=0)),
                ('rows_deleted', models.BigIntegerField(default=0)),
                ('rows_failed', models.BigIntegerField(default=0)),
                ('query_executed', models.TextField(blank=True, null=True)),
                ('error_details', models.JSONField(blank=True, null=True)),
                ('warnings', models.JSONField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True, db_index=True)),
                ('job', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='logs', to='client.replicationjob')),
                ('table_mapping', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='logs', to='client.tablemapping')),
            ],
            options={
                'verbose_name': 'Replication Log',
                'verbose_name_plural': 'Replication Logs',
                'db_table': 'replication_log',
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='ColumnMapping',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('source_column', models.CharField(help_text='Source column name', max_length=255)),
                ('source_type', models.CharField(blank=True, help_text='Source column data type (e.g., VARCHAR(255), INT, BIGINT)', max_length=100)),
                ('source_data_type', models.CharField(blank=True, help_text='Deprecated: use source_type instead', max_length=100)),
                ('target_column', models.CharField(help_text='Target column name (can be different from source)', max_length=255)),
                ('target_type', models.CharField(blank=True, help_text='Target column data type', max_length=100)),
                ('target_data_type', models.CharField(blank=True, help_text='Deprecated: use target_type instead', max_length=100)),
                ('is_enabled', models.BooleanField(default=True, help_text='Whether this column should be replicated')),
                ('is_primary_key', models.BooleanField(default=False, help_text='Is this column part of the primary key')),
                ('is_nullable', models.BooleanField(default=True, help_text='Can this column contain NULL values')),
                ('transform_function', models.CharField(choices=[('none', 'No Transformation'), ('encrypt', 'Encrypt'), ('hash', 'Hash (SHA256)'), ('mask', 'Mask (e.g., XXX-XX-1234)'), ('uppercase', 'Convert to Uppercase'), ('lowercase', 'Convert to Lowercase'), ('trim', 'Trim Whitespace'), ('null_to_default', 'Convert NULL to Default')], default='none', help_text='Transformation to apply to column data', max_length=50)),
                ('transform_params', models.JSONField(blank=True, help_text='Additional parameters for transformation', null=True)),
                ('transformation_rule', models.TextField(blank=True, help_text='Optional transformation rule (SQL expression or function)', null=True)),
                ('default_value', models.CharField(blank=True, help_text='Default value if source is NULL', max_length=255, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('table_mapping', models.ForeignKey(help_text='Parent table mapping', on_delete=django.db.models.deletion.CASCADE, related_name='column_mappings', to='client.tablemapping')),
            ],
            options={
                'verbose_name': 'Column Mapping',
                'verbose_name_plural': 'Column Mappings',
                'db_table': 'column_mapping',
                'ordering': ['source_column'],
            },
        ),
        migrations.AddConstraint(
            model_name='clientdatabase',
            constraint=models.UniqueConstraint(condition=models.Q(('is_target', True)), fields=('client', 'is_target'), name='unique_target_per_client'),
        ),
        migrations.AddIndex(
            model_name='replicationjob',
            index=models.Index(fields=['-created_at'], name='replication_created_42f9f3_idx'),
        ),
        migrations.AddIndex(
            model_name='replicationjob',
            index=models.Index(fields=['status'], name='replication_status_1ea72c_idx'),
        ),
        migrations.AddIndex(
            model_name='replicationjob',
            index=models.Index(fields=['job_id'], name='replication_job_id_795993_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='tablemapping',
            unique_together={('replication_config', 'source_table')},
        ),
        migrations.AlterUniqueTogether(
            name='schemaversion',
            unique_together={('table_mapping', 'version')},
        ),
        migrations.AddIndex(
            model_name='replicationlog',
            index=models.Index(fields=['-created_at'], name='replication_created_a45adb_idx'),
        ),
        migrations.AddIndex(
            model_name='replicationlog',
            index=models.Index(fields=['status'], name='replication_status_934356_idx'),
        ),
        migrations.AddIndex(
            model_name='columnmapping',
            index=models.Index(fields=['table_mapping', 'is_enabled'], name='column_mapp_table_m_22871f_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='columnmapping',
            unique_together={('table_mapping', 'source_column')},
        ),
    ]
